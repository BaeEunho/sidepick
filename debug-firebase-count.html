<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Count Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .section {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
        }
        pre {
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .count-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .count-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .count-card h3 {
            margin: 0 0 10px 0;
        }
        .count-card .number {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
        .conservative { border-left: 5px solid #0066cc; }
        .progressive { border-left: 5px solid #ff6b6b; }
        .full { background: #ffcccc; }
        .available { background: #ccffcc; }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Firebase 참가자 수 디버깅</h1>
    
    <div class="section">
        <h2>현재 사용자 정보</h2>
        <div id="user-info"></div>
    </div>
    
    <div class="section">
        <h2>Firebase 실시간 참가자 수</h2>
        <button onclick="checkFirebaseCount()">Firebase 조회</button>
        <button onclick="simulateMeetingSchedule()">meeting-schedule 시뮬레이션</button>
        
        <div class="count-display">
            <div class="count-card progressive">
                <h3>진보 모임</h3>
                <div>남성: <span class="number" id="prog-male">0</span>/4</div>
                <div>여성: <span class="number" id="prog-female">0</span>/4</div>
            </div>
            <div class="count-card conservative">
                <h3>보수 모임</h3>
                <div>남성: <span class="number" id="cons-male">0</span>/4</div>
                <div>여성: <span class="number" id="cons-female">0</span>/4</div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>SessionStorage 데이터</h2>
        <button onclick="checkSessionStorage()">SessionStorage 확인</button>
        <button onclick="clearSessionCounts()">카운트 초기화</button>
        <pre id="session-data"></pre>
    </div>
    
    <div class="section">
        <h2>실행 로그</h2>
        <div id="log" class="log"></div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function displayUserInfo() {
            const userInfo = {
                email: sessionStorage.getItem('userEmail'),
                gender: sessionStorage.getItem('userGender'),
                politicalType: sessionStorage.getItem('politicalType'),
                orientation: getOrientation()
            };
            
            document.getElementById('user-info').innerHTML = `
                <p><strong>Email:</strong> ${userInfo.email || 'Not logged in'}</p>
                <p><strong>Gender:</strong> ${userInfo.gender || 'Not set'}</p>
                <p><strong>Political Type:</strong> ${userInfo.politicalType || 'Not set'}</p>
                <p><strong>Orientation:</strong> ${userInfo.orientation || 'Not set'}</p>
            `;
        }
        
        function getOrientation() {
            const politicalType = sessionStorage.getItem('politicalType');
            const progressiveCodes = ['MPOS', 'MPON', 'MPTS', 'MPTN', 'GPOS', 'GPON', 'GPTS', 'GPTN'];
            return progressiveCodes.includes(politicalType) ? 'progressive' : 'conservative';
        }
        
        async function checkFirebaseCount() {
            log('Firebase 참가자 수 조회 시작...');
            
            try {
                const API_URL = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3001' 
                    : 'https://sidepick.onrender.com';
                
                const response = await fetch(`${API_URL}/api/meetings/attendance`);
                const data = await response.json();
                
                log(`Response status: ${response.status}`);
                
                if (data.success && data.data) {
                    let progressiveMale = 0, progressiveFemale = 0;
                    let conservativeMale = 0, conservativeFemale = 0;
                    
                    // Firebase 데이터 집계
                    Object.values(data.data).forEach(meeting => {
                        log(`Meeting: ${meeting.orientation} - Male: ${meeting.male}, Female: ${meeting.female}`);
                        
                        if (meeting.orientation === 'progressive') {
                            progressiveMale += meeting.male;
                            progressiveFemale += meeting.female;
                        } else if (meeting.orientation === 'conservative') {
                            conservativeMale += meeting.male;
                            conservativeFemale += meeting.female;
                        }
                    });
                    
                    // 화면 업데이트
                    document.getElementById('prog-male').textContent = progressiveMale;
                    document.getElementById('prog-female').textContent = progressiveFemale;
                    document.getElementById('cons-male').textContent = conservativeMale;
                    document.getElementById('cons-female').textContent = conservativeFemale;
                    
                    // 마감 여부 표시
                    updateCardStatus('prog-male', progressiveMale);
                    updateCardStatus('prog-female', progressiveFemale);
                    updateCardStatus('cons-male', conservativeMale);
                    updateCardStatus('cons-female', conservativeFemale);
                    
                    log(`진보: 남 ${progressiveMale}/4, 여 ${progressiveFemale}/4`, 'success');
                    log(`보수: 남 ${conservativeMale}/4, 여 ${conservativeFemale}/4`, 'success');
                    
                    // 현재 사용자가 신청 가능한지 확인
                    const userGender = sessionStorage.getItem('userGender');
                    const userOrientation = getOrientation();
                    
                    if (userGender && userOrientation) {
                        const count = userOrientation === 'progressive' 
                            ? (userGender === 'male' ? progressiveMale : progressiveFemale)
                            : (userGender === 'male' ? conservativeMale : conservativeFemale);
                        
                        if (count >= 4) {
                            log(`⚠️ ${userOrientation} ${userGender} 마감됨! (${count}/4)`, 'error');
                        } else {
                            log(`✅ ${userOrientation} ${userGender} 신청 가능 (${count}/4)`, 'success');
                        }
                    }
                } else {
                    log('Firebase 데이터 없음', 'error');
                }
            } catch (error) {
                log(`Firebase 조회 오류: ${error.message}`, 'error');
            }
        }
        
        function updateCardStatus(elementId, count) {
            const element = document.getElementById(elementId);
            const card = element.closest('.count-card');
            
            if (count >= 4) {
                element.style.color = 'red';
                card.classList.add('full');
                card.classList.remove('available');
            } else {
                element.style.color = 'green';
                card.classList.add('available');
                card.classList.remove('full');
            }
        }
        
        function checkSessionStorage() {
            const data = {
                confirmedMeetingCounts: JSON.parse(sessionStorage.getItem('confirmedMeetingCounts') || '{}'),
                meetingCounts: JSON.parse(sessionStorage.getItem('meetingCounts') || '{}'),
                appliedMeetings: JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}')
            };
            
            document.getElementById('session-data').textContent = JSON.stringify(data, null, 2);
            log('SessionStorage 데이터 표시됨');
        }
        
        function clearSessionCounts() {
            sessionStorage.removeItem('confirmedMeetingCounts');
            sessionStorage.removeItem('meetingCounts');
            log('SessionStorage 카운트 초기화됨', 'success');
            checkSessionStorage();
        }
        
        async function simulateMeetingSchedule() {
            log('=== meeting-schedule 페이지 시뮬레이션 ===');
            
            const userGender = sessionStorage.getItem('userGender');
            const userOrientation = getOrientation();
            
            log(`User: ${userOrientation} ${userGender}`);
            
            // Firebase 데이터 가져오기
            await checkFirebaseCount();
            
            // updateMeetingAvailability 로직 시뮬레이션
            const API_URL = window.location.hostname === 'localhost' 
                ? 'http://localhost:3001' 
                : 'https://sidepick.onrender.com';
            
            const response = await fetch(`${API_URL}/api/meetings/attendance`);
            const data = await response.json();
            
            if (data.success && data.data) {
                let currentCount = 0;
                
                Object.values(data.data).forEach(meeting => {
                    if (meeting.orientation === userOrientation) {
                        currentCount += meeting[userGender] || 0;
                    }
                });
                
                log(`현재 ${userOrientation} ${userGender} 참가자: ${currentCount}명`);
                
                if (currentCount >= 4) {
                    log('❌ 마감 상태 - "알림 받기" 버튼이 표시되어야 함', 'error');
                } else {
                    log('✅ 신청 가능 - "신청하기" 버튼이 표시되어야 함', 'success');
                }
            }
        }
        
        // 초기 로드
        displayUserInfo();
        checkFirebaseCount();
    </script>
</body>
</html>