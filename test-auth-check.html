<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Check Test Suite</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #FF6B6B;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #FF6B6B;
            margin-top: 30px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-case {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #4ECDC4;
        }
        
        .test-case h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        button {
            background: #FF6B6B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #FF5252;
        }
        
        button.secondary {
            background: #4ECDC4;
        }
        
        button.secondary:hover {
            background: #45B7B8;
        }
        
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
        }
        
        .result.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .result.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .current-state {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            max-width: 300px;
        }
        
        .current-state h3 {
            margin-top: 0;
            color: #FF6B6B;
        }
        
        .state-info {
            font-family: monospace;
            font-size: 12px;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Mock UI elements for testing */
        .nav-cta, .auth-buttons, #mobileMenuAuth, #fixedCta {
            margin: 10px 0;
            padding: 15px;
            background: #fafafa;
            border: 1px dashed #ddd;
            border-radius: 5px;
        }
        
        .nav-cta::before {
            content: "Nav CTA: ";
            font-weight: bold;
            color: #666;
        }
        
        .auth-buttons::before {
            content: "Auth Buttons: ";
            font-weight: bold;
            color: #666;
        }
        
        #mobileMenuAuth::before {
            content: "Mobile Menu: ";
            font-weight: bold;
            color: #666;
        }
        
        #fixedCta::before {
            content: "Fixed CTA: ";
            font-weight: bold;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>SidePick Auth Check Test Suite</h1>
    
    <!-- Current State Display -->
    <div class="current-state">
        <h3>Current State</h3>
        <button onclick="refreshState()" class="secondary">Refresh</button>
        <div id="currentStateDisplay" class="state-info"></div>
    </div>
    
    <!-- Test Sections -->
    <div class="test-section">
        <h2>1. getUserState() Tests</h2>
        
        <div class="test-case">
            <h3>Test 1.1: Anonymous User State</h3>
            <button onclick="testAnonymousState()">Run Test</button>
            <div id="result-1-1" class="result"></div>
        </div>
        
        <div class="test-case">
            <h3>Test 1.2: Authenticated User State</h3>
            <button onclick="testAuthenticatedState()">Run Test</button>
            <div id="result-1-2" class="result"></div>
        </div>
        
        <div class="test-case">
            <h3>Test 1.3: Verified User State</h3>
            <button onclick="testVerifiedState()">Run Test</button>
            <div id="result-1-3" class="result"></div>
        </div>
        
        <div class="test-case">
            <h3>Test 1.4: Invalid JSON in userProfile</h3>
            <button onclick="testInvalidUserProfile()">Run Test</button>
            <div id="result-1-4" class="result"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>2. checkPageAccess() Tests</h2>
        
        <div class="test-case">
            <h3>Test 2.1: Anonymous accessing authenticated page</h3>
            <button onclick="testAnonymousAccessAuth()">Run Test</button>
            <div id="result-2-1" class="result"></div>
        </div>
        
        <div class="test-case">
            <h3>Test 2.2: Authenticated accessing verified page</h3>
            <button onclick="testAuthAccessVerified()">Run Test</button>
            <div id="result-2-2" class="result"></div>
        </div>
        
        <div class="test-case">
            <h3>Test 2.3: Verified accessing any page</h3>
            <button onclick="testVerifiedAccess()">Run Test</button>
            <div id="result-2-3" class="result"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>3. UI Update Tests</h2>
        
        <div class="test-case">
            <h3>Test 3.1: updateHeader() for different states</h3>
            <div class="nav-cta"></div>
            <button onclick="testUpdateHeader()">Run Test</button>
            <div id="result-3-1" class="result"></div>
        </div>
        
        <div class="test-case">
            <h3>Test 3.2: updateIndexHeader() for different states</h3>
            <div class="auth-buttons"></div>
            <div id="mobileMenuAuth"></div>
            <button onclick="testUpdateIndexHeader()">Run Test</button>
            <div id="result-3-2" class="result"></div>
        </div>
        
        <div class="test-case">
            <h3>Test 3.3: updateFixedCTA() for different states</h3>
            <div id="fixedCta"></div>
            <button onclick="testUpdateFixedCTA()">Run Test</button>
            <div id="result-3-3" class="result"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>4. Login/Logout Tests</h2>
        
        <div class="test-case">
            <h3>Test 4.1: Login Function</h3>
            <button onclick="testLogin()">Run Test</button>
            <div id="result-4-1" class="result"></div>
        </div>
        
        <div class="test-case">
            <h3>Test 4.2: Logout Function</h3>
            <button onclick="testLogout()">Run Test</button>
            <div id="result-4-2" class="result"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>5. setTestComplete() Tests</h2>
        
        <div class="test-case">
            <h3>Test 5.1: Set Test Complete</h3>
            <button onclick="testSetTestComplete()">Run Test</button>
            <div id="result-5-1" class="result"></div>
        </div>
        
        <div class="test-case">
            <h3>Test 5.2: Edge Cases - Missing Data</h3>
            <button onclick="testSetTestCompleteEdgeCases()">Run Test</button>
            <div id="result-5-2" class="result"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Utility Functions</h2>
        <button onclick="clearAllData()" class="secondary">Clear All Session Data</button>
        <button onclick="runAllTests()">Run All Tests</button>
    </div>
    
    <script src="auth-check.js"></script>
    <script>
        // Helper functions
        function showResult(elementId, message, isSuccess = true) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.textContent = message;
            resultDiv.className = 'result ' + (isSuccess ? 'success' : 'error');
            resultDiv.style.display = 'block';
        }
        
        function refreshState() {
            const state = AuthManager.getUserState();
            const sessionData = {};
            for (let key in sessionStorage) {
                sessionData[key] = sessionStorage.getItem(key);
            }
            
            document.getElementById('currentStateDisplay').textContent = 
                `User State: ${JSON.stringify(state, null, 2)}\n\nSession Storage:\n${JSON.stringify(sessionData, null, 2)}`;
        }
        
        function clearAllData() {
            sessionStorage.clear();
            refreshState();
            alert('All session data cleared!');
        }
        
        // Test 1.1: Anonymous User State
        function testAnonymousState() {
            sessionStorage.clear();
            const state = AuthManager.getUserState();
            
            const expected = {
                type: 'anonymous',
                isLoggedIn: false
            };
            
            if (JSON.stringify(state) === JSON.stringify(expected)) {
                showResult('result-1-1', 'PASS: Anonymous state correctly identified\n' + JSON.stringify(state, null, 2));
            } else {
                showResult('result-1-1', 'FAIL: Expected ' + JSON.stringify(expected) + ' but got ' + JSON.stringify(state), false);
            }
            refreshState();
        }
        
        // Test 1.2: Authenticated User State
        function testAuthenticatedState() {
            sessionStorage.clear();
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('userProfile', JSON.stringify({
                name: '테스트 유저',
                email: 'test@example.com',
                gender: 'male'
            }));
            
            const state = AuthManager.getUserState();
            
            if (state.type === 'authenticated' && state.isLoggedIn === true && state.profile.name === '테스트 유저') {
                showResult('result-1-2', 'PASS: Authenticated state correctly identified\n' + JSON.stringify(state, null, 2));
            } else {
                showResult('result-1-2', 'FAIL: Incorrect authenticated state\n' + JSON.stringify(state, null, 2), false);
            }
            refreshState();
        }
        
        // Test 1.3: Verified User State
        function testVerifiedState() {
            sessionStorage.clear();
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('politicalType', 'MPOS');
            sessionStorage.setItem('userProfile', JSON.stringify({
                name: '검증된 유저',
                email: 'verified@example.com',
                gender: 'female'
            }));
            
            const state = AuthManager.getUserState();
            
            if (state.type === 'verified' && state.politicalType === 'MPOS' && state.profile.name === '검증된 유저') {
                showResult('result-1-3', 'PASS: Verified state correctly identified\n' + JSON.stringify(state, null, 2));
            } else {
                showResult('result-1-3', 'FAIL: Incorrect verified state\n' + JSON.stringify(state, null, 2), false);
            }
            refreshState();
        }
        
        // Test 1.4: Invalid JSON in userProfile
        function testInvalidUserProfile() {
            sessionStorage.clear();
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('userProfile', 'invalid json {');
            
            const state = AuthManager.getUserState();
            
            if (state.type === 'authenticated' && Object.keys(state.profile).length === 0) {
                showResult('result-1-4', 'PASS: Invalid JSON handled gracefully\n' + JSON.stringify(state, null, 2));
            } else {
                showResult('result-1-4', 'FAIL: Invalid JSON not handled properly\n' + JSON.stringify(state, null, 2), false);
            }
            refreshState();
        }
        
        // Test 2.1: Anonymous accessing authenticated page
        function testAnonymousAccessAuth() {
            sessionStorage.clear();
            
            // Override alert and location to test
            const originalAlert = window.alert;
            const originalLocation = window.location.href;
            let alertMessage = '';
            let redirectUrl = '';
            
            window.alert = (msg) => { alertMessage = msg; };
            Object.defineProperty(window, 'location', {
                value: { href: '' },
                writable: true
            });
            
            const result = AuthManager.checkPageAccess('authenticated');
            
            window.alert = originalAlert;
            
            if (!result && alertMessage === '로그인이 필요한 서비스입니다.' && window.location.href === 'login.html') {
                showResult('result-2-1', 'PASS: Anonymous user correctly blocked from authenticated page');
            } else {
                showResult('result-2-1', `FAIL: Result: ${result}, Alert: ${alertMessage}, Redirect: ${window.location.href}`, false);
            }
            
            window.location.href = originalLocation;
            refreshState();
        }
        
        // Test 2.2: Authenticated accessing verified page
        function testAuthAccessVerified() {
            sessionStorage.clear();
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('userProfile', JSON.stringify({ name: '테스트' }));
            
            const originalAlert = window.alert;
            const originalLocation = window.location.href;
            let alertMessage = '';
            
            window.alert = (msg) => { alertMessage = msg; };
            Object.defineProperty(window, 'location', {
                value: { href: '' },
                writable: true
            });
            
            const result = AuthManager.checkPageAccess('verified');
            
            window.alert = originalAlert;
            
            if (!result && alertMessage === '정치 성향 테스트를 먼저 완료해주세요.' && window.location.href === 'political-test.html?logged_in=true') {
                showResult('result-2-2', 'PASS: Authenticated user correctly redirected to test');
            } else {
                showResult('result-2-2', `FAIL: Result: ${result}, Alert: ${alertMessage}, Redirect: ${window.location.href}`, false);
            }
            
            window.location.href = originalLocation;
            refreshState();
        }
        
        // Test 2.3: Verified accessing any page
        function testVerifiedAccess() {
            sessionStorage.clear();
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('politicalType', 'MPOS');
            sessionStorage.setItem('userProfile', JSON.stringify({ name: '검증됨' }));
            
            const authResult = AuthManager.checkPageAccess('authenticated');
            const verifiedResult = AuthManager.checkPageAccess('verified');
            
            if (authResult && verifiedResult) {
                showResult('result-2-3', 'PASS: Verified user can access all pages');
            } else {
                showResult('result-2-3', `FAIL: Auth: ${authResult}, Verified: ${verifiedResult}`, false);
            }
            refreshState();
        }
        
        // Test 3.1: updateHeader()
        function testUpdateHeader() {
            const navCta = document.querySelector('.nav-cta');
            let results = [];
            
            // Test anonymous
            sessionStorage.clear();
            AuthManager.updateHeader();
            results.push(`Anonymous: ${navCta.innerHTML.includes('성향 테스트 받기') && !navCta.innerHTML.includes('로그아웃')}`);
            
            // Test authenticated
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('userProfile', JSON.stringify({ name: '김철수' }));
            AuthManager.updateHeader();
            results.push(`Authenticated: ${navCta.innerHTML.includes('김철수님') && navCta.innerHTML.includes('성향 테스트 받기')}`);
            
            // Test verified
            sessionStorage.setItem('politicalType', 'MPOS');
            AuthManager.updateHeader();
            results.push(`Verified: ${navCta.innerHTML.includes('김철수님') && navCta.innerHTML.includes('마이페이지')}`);
            
            const allPass = results.every(r => r.includes('true'));
            showResult('result-3-1', allPass ? 'PASS: All header states updated correctly\n' + results.join('\n') : 
                'FAIL: Header update issues\n' + results.join('\n'), allPass);
            refreshState();
        }
        
        // Test 3.2: updateIndexHeader()
        function testUpdateIndexHeader() {
            const authButtons = document.querySelector('.auth-buttons');
            let results = [];
            
            // Test anonymous
            sessionStorage.clear();
            AuthManager.updateIndexHeader();
            results.push(`Anonymous: ${authButtons.innerHTML.includes('로그인') && authButtons.innerHTML.includes('회원가입')}`);
            
            // Test authenticated
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('userProfile', JSON.stringify({ name: '이영희' }));
            AuthManager.updateIndexHeader();
            results.push(`Authenticated: ${authButtons.innerHTML.includes('이영희님') && authButtons.innerHTML.includes('마이페이지')}`);
            
            // Test verified
            sessionStorage.setItem('politicalType', 'GCOS');
            AuthManager.updateIndexHeader();
            results.push(`Verified: ${authButtons.innerHTML.includes('이영희님') && authButtons.innerHTML.includes('마이페이지')}`);
            
            const allPass = results.every(r => r.includes('true'));
            showResult('result-3-2', allPass ? 'PASS: All index header states updated correctly\n' + results.join('\n') : 
                'FAIL: Index header update issues\n' + results.join('\n'), allPass);
            refreshState();
        }
        
        // Test 3.3: updateFixedCTA()
        function testUpdateFixedCTA() {
            const fixedCta = document.getElementById('fixedCta');
            let results = [];
            
            // Test anonymous
            sessionStorage.clear();
            AuthManager.updateFixedCTA();
            results.push(`Anonymous: ${fixedCta.innerHTML.includes('political-test.html') && !fixedCta.innerHTML.includes('logged_in=true')}`);
            
            // Test authenticated
            sessionStorage.setItem('isLoggedIn', 'true');
            AuthManager.updateFixedCTA();
            results.push(`Authenticated: ${fixedCta.innerHTML.includes('political-test.html?logged_in=true')}`);
            
            // Test verified
            sessionStorage.setItem('politicalType', 'MPOS');
            AuthManager.updateFixedCTA();
            results.push(`Verified: ${fixedCta.innerHTML.includes('meeting-schedule.html')}`);
            
            const allPass = results.every(r => r.includes('true'));
            showResult('result-3-3', allPass ? 'PASS: All fixed CTA states updated correctly\n' + results.join('\n') : 
                'FAIL: Fixed CTA update issues\n' + results.join('\n'), allPass);
            refreshState();
        }
        
        // Test 4.1: Login Function
        function testLogin() {
            sessionStorage.clear();
            
            const testProfile = {
                name: '박지민',
                email: 'jimin@test.com',
                gender: 'female',
                birthYear: 1995
            };
            
            AuthManager.login('jimin@test.com', testProfile);
            
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            const email = sessionStorage.getItem('userEmail') === 'jimin@test.com';
            const profile = JSON.parse(sessionStorage.getItem('userProfile'));
            const gender = sessionStorage.getItem('userGender') === 'female';
            
            if (isLoggedIn && email && profile.name === '박지민' && gender) {
                showResult('result-4-1', 'PASS: Login function works correctly\n' + 
                    `Logged in: ${isLoggedIn}\nEmail: ${sessionStorage.getItem('userEmail')}\n` +
                    `Profile: ${JSON.stringify(profile, null, 2)}\nGender: ${sessionStorage.getItem('userGender')}`);
            } else {
                showResult('result-4-1', 'FAIL: Login data not saved correctly', false);
            }
            refreshState();
        }
        
        // Test 4.2: Logout Function
        function testLogout() {
            // Set up logged in state
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('userEmail', 'test@test.com');
            sessionStorage.setItem('politicalType', 'MPOS');
            
            // Override confirm and location
            const originalConfirm = window.confirm;
            const originalLocation = window.location.href;
            
            window.confirm = () => true;
            Object.defineProperty(window, 'location', {
                value: { href: '' },
                writable: true
            });
            
            AuthManager.logout();
            
            window.confirm = originalConfirm;
            
            const isEmpty = sessionStorage.length === 0;
            const redirected = window.location.href === 'index.html';
            
            if (isEmpty && redirected) {
                showResult('result-4-2', 'PASS: Logout clears session and redirects');
            } else {
                showResult('result-4-2', `FAIL: Session empty: ${isEmpty}, Redirected: ${redirected}`, false);
            }
            
            window.location.href = originalLocation;
            refreshState();
        }
        
        // Test 5.1: Set Test Complete
        function testSetTestComplete() {
            sessionStorage.clear();
            
            const testData = {
                code: 'GPOS',
                title: '정부주도 진보개방 사회참여형',
                orientation: 'progressive'
            };
            
            const beforeTime = new Date().toISOString();
            AuthManager.setTestComplete(testData);
            const afterTime = new Date().toISOString();
            
            const politicalType = sessionStorage.getItem('politicalType');
            const userType = JSON.parse(sessionStorage.getItem('userType'));
            const testCompletedAt = sessionStorage.getItem('testCompletedAt');
            
            if (politicalType === 'GPOS' && 
                userType.code === 'GPOS' && 
                userType.title === '정부주도 진보개방 사회참여형' &&
                userType.orientation === 'progressive' &&
                testCompletedAt >= beforeTime && 
                testCompletedAt <= afterTime) {
                showResult('result-5-1', 'PASS: Test completion data saved correctly\n' +
                    `Political Type: ${politicalType}\nUser Type: ${JSON.stringify(userType, null, 2)}\n` +
                    `Completed At: ${testCompletedAt}`);
            } else {
                showResult('result-5-1', 'FAIL: Test completion data incorrect', false);
            }
            refreshState();
        }
        
        // Test 5.2: Edge Cases
        function testSetTestCompleteEdgeCases() {
            sessionStorage.clear();
            
            // Test with minimal data
            AuthManager.setTestComplete({ code: 'TEST' });
            
            const minimalType = sessionStorage.getItem('politicalType');
            const minimalUserType = JSON.parse(sessionStorage.getItem('userType'));
            
            // Test with missing properties
            const results = [];
            results.push(`Minimal data handled: ${minimalType === 'TEST'}`);
            results.push(`Undefined properties saved as undefined: ${minimalUserType.title === undefined}`);
            
            // Test overwriting existing data
            AuthManager.setTestComplete({ code: 'NEW', title: 'New Type' });
            const overwrittenType = sessionStorage.getItem('politicalType');
            results.push(`Data overwritten correctly: ${overwrittenType === 'NEW'}`);
            
            const allPass = results.every(r => r.includes('true'));
            showResult('result-5-2', allPass ? 'PASS: Edge cases handled correctly\n' + results.join('\n') : 
                'FAIL: Edge case issues\n' + results.join('\n'), allPass);
            refreshState();
        }
        
        // Run all tests
        function runAllTests() {
            testAnonymousState();
            setTimeout(() => testAuthenticatedState(), 100);
            setTimeout(() => testVerifiedState(), 200);
            setTimeout(() => testInvalidUserProfile(), 300);
            setTimeout(() => testAnonymousAccessAuth(), 400);
            setTimeout(() => testAuthAccessVerified(), 500);
            setTimeout(() => testVerifiedAccess(), 600);
            setTimeout(() => testUpdateHeader(), 700);
            setTimeout(() => testUpdateIndexHeader(), 800);
            setTimeout(() => testUpdateFixedCTA(), 900);
            setTimeout(() => testLogin(), 1000);
            setTimeout(() => testLogout(), 1100);
            setTimeout(() => testSetTestComplete(), 1200);
            setTimeout(() => testSetTestCompleteEdgeCases(), 1300);
        }
        
        // Initialize on load
        refreshState();
    </script>
</body>
</html>