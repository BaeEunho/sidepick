<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Status Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
        }
        pre {
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status-box {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .pending { background: #FFA500; color: white; }
        .payment_completed { background: #8B5CF6; color: white; }
        .confirmed { background: #27ae60; color: white; }
    </style>
</head>
<body>
    <h1>Payment Status 디버깅</h1>
    
    <div class="section">
        <h2>1. SessionStorage 확인</h2>
        <button onclick="checkSessionData()">Session 데이터 확인</button>
        <pre id="session-data"></pre>
    </div>
    
    <div class="section">
        <h2>2. Firebase 데이터 확인</h2>
        <button onclick="checkFirebaseData()">Firebase 데이터 확인</button>
        <pre id="firebase-data"></pre>
    </div>
    
    <div class="section">
        <h2>3. 상태 수동 변경</h2>
        <button onclick="setPaymentCompleted('progressive')">진보 - payment_completed로 변경</button>
        <button onclick="setPaymentCompleted('conservative')">보수 - payment_completed로 변경</button>
        <button onclick="clearApplications()">모든 신청 초기화</button>
    </div>
    
    <div class="section">
        <h2>4. 버튼 상태 시뮬레이션</h2>
        <div id="button-simulation"></div>
    </div>
    
    <script>
        function checkSessionData() {
            const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
            const userEmail = sessionStorage.getItem('userEmail');
            const userGender = sessionStorage.getItem('userGender');
            const politicalType = sessionStorage.getItem('politicalType');
            
            const data = {
                userEmail,
                userGender,
                politicalType,
                appliedMeetings
            };
            
            document.getElementById('session-data').textContent = JSON.stringify(data, null, 2);
            
            // 버튼 시뮬레이션
            simulateButtons(appliedMeetings);
        }
        
        async function checkFirebaseData() {
            try {
                const token = localStorage.getItem('authToken');
                const API_URL = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3001' 
                    : 'https://sidepick.onrender.com';
                
                const response = await fetch(`${API_URL}/api/user/meetings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                document.getElementById('firebase-data').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('firebase-data').textContent = 'Error: ' + error.message;
            }
        }
        
        function setPaymentCompleted(orientation) {
            const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
            
            if (appliedMeetings[orientation]) {
                appliedMeetings[orientation].status = 'payment_completed';
                appliedMeetings[orientation].paymentCompletedAt = new Date().toISOString();
                sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
                alert(`${orientation} 상태를 payment_completed로 변경했습니다.`);
                checkSessionData();
            } else {
                alert(`${orientation} 신청 정보가 없습니다.`);
            }
        }
        
        function clearApplications() {
            if (confirm('정말로 모든 신청을 초기화하시겠습니까?')) {
                sessionStorage.removeItem('appliedMeetings');
                alert('초기화되었습니다.');
                checkSessionData();
            }
        }
        
        function simulateButtons(appliedMeetings) {
            const container = document.getElementById('button-simulation');
            container.innerHTML = '';
            
            ['progressive', 'conservative'].forEach(orientation => {
                const div = document.createElement('div');
                div.style.margin = '10px 0';
                
                const label = document.createElement('h3');
                label.textContent = `${orientation === 'progressive' ? '진보' : '보수'} 모임:`;
                div.appendChild(label);
                
                const statusBox = document.createElement('div');
                
                if (appliedMeetings[orientation]) {
                    const status = appliedMeetings[orientation].status;
                    statusBox.className = `status-box ${status}`;
                    
                    let buttonText = '';
                    if (status === 'pending') {
                        buttonText = '결제 진행하기';
                    } else if (status === 'payment_pending') {
                        buttonText = '입금 대기 중';
                    } else if (status === 'confirmed' || status === 'paid') {
                        buttonText = '참가 확정';
                    } else {
                        buttonText = status;
                    }
                    
                    statusBox.textContent = `Status: ${status} → 버튼: "${buttonText}"`;
                } else {
                    statusBox.className = 'status-box';
                    statusBox.style.background = '#e0e0e0';
                    statusBox.textContent = '신청 없음 → 버튼: "참가 신청하기"';
                }
                
                div.appendChild(statusBox);
                container.appendChild(div);
            });
        }
        
        // 페이지 로드 시 자동 실행
        checkSessionData();
    </script>
</body>
</html>