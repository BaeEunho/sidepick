<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì˜ˆì•½ í™•ì¸ - ì‚¬ì´ë“œí”½</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="booking-confirm-styles.css">
    <script src="auth-system.js"></script>
    <script src="auth-check.js"></script>
    <script src="api-client.js"></script>
    <!-- data-system.js ì œê±° - Firebase ì§ì ‘ ì‚¬ìš© -->
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="index.html">ì‚¬ì´ë“œí”½</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html#intro">ì„œë¹„ìŠ¤ ì†Œê°œ</a></li>
                <li><a href="index.html#test">ì„±í–¥ í…ŒìŠ¤íŠ¸</a></li>
                <li><a href="meeting-schedule.html">ì†Œê°œíŒ… ì¼ì •</a></li>
                <li><a href="index.html#faq">FAQ</a></li>
            </ul>
            <div class="auth-buttons">
                <!-- AuthManagerê°€ ìë™ìœ¼ë¡œ ì±„ì›Œì¤Œ -->
            </div>
        </nav>
    </header>

    <!-- ì˜ˆì•½ í™•ì¸ ì„¹ì…˜ -->
    <section class="booking-confirm-section">
        <div class="container">
            <div class="booking-header">
                <h1>ì˜ˆì•½ í™•ì¸</h1>
                <p>ì„ íƒí•˜ì‹  ëª¨ì„ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ì‹ ì²­ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”</p>
            </div>
            
            <div class="booking-content">
                <!-- ëª¨ì„ ì •ë³´ -->
                <div class="selected-meeting-info">
                    <h2>ì„ íƒí•œ ì†Œê°œíŒ… ì •ë³´</h2>
                    <div class="meeting-detail-card">
                        <div class="detail-row">
                            <span class="label">ëª¨ì„ ì´ë¦„</span>
                            <span class="value" id="meeting-title">ë¡œë”© ì¤‘...</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">ë‚ ì§œ</span>
                            <span class="value" id="meeting-date">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">ì¥ì†Œ</span>
                            <span class="value" id="meeting-location">-</span>
                        </div>
                        <div class="detail-row highlight">
                            <span class="label">ì°¸ê°€ë¹„</span>
                            <span class="value price">45,000ì›</span>
                        </div>
                    </div>
                </div>

                <!-- ì°¸ê°€ì ì •ë³´ -->
                <div class="participant-form-section">
                    <h2>ì°¸ê°€ì ì •ë³´</h2>
                    <div class="info-auto-fill">
                        â„¹ï¸ íšŒì› ì •ë³´ë¡œ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤
                    </div>
                    
                    <form class="participant-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="applicant-name">ì´ë¦„</label>
                                <input type="text" id="applicant-name" class="auto-filled" readonly>
                            </div>
                            <div class="form-group">
                                <label for="applicant-phone">ì—°ë½ì²˜</label>
                                <input type="tel" id="applicant-phone" class="auto-filled" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="applicant-email">ì´ë©”ì¼</label>
                            <input type="email" id="applicant-email" class="auto-filled" readonly>
                        </div>
                    </form>

                    <!-- ì•½ê´€ ë™ì˜ -->
                    <div class="terms-section">
                        <h3>ì•½ê´€ ë™ì˜</h3>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="agree-checkbox" required>
                                <span>í™˜ë¶ˆ ì •ì±…ì„ í™•ì¸í–ˆìœ¼ë©°, ì´ì— ë™ì˜í•©ë‹ˆë‹¤ (í•„ìˆ˜)</span>
                            </label>
                        </div>
                    </div>

                    <!-- ì•ˆë‚´ì‚¬í•­ -->
                    <div class="notice-section">
                        <h3>ğŸ“Œ í™˜ë¶ˆ ì •ì±… ì•ˆë‚´</h3>
                        <ul>
                            <li>ëª¨ì„ 3ì¼ ì „ê¹Œì§€: 100% í™˜ë¶ˆ</li>
                            <li>ëª¨ì„ 2ì¼ ì „: 70% í™˜ë¶ˆ</li>
                            <li>ëª¨ì„ 1ì¼ ì „: 50% í™˜ë¶ˆ</li>
                            <li>ëª¨ì„ ë‹¹ì¼: í™˜ë¶ˆ ë¶ˆê°€</li>
                        </ul>
                    </div>

                    <!-- ë²„íŠ¼ ì˜ì—­ -->
                    <div class="button-group">
                        <button class="btn-secondary" onclick="history.back()">ì´ì „ìœ¼ë¡œ</button>
                        <button class="btn-primary" id="proceed-payment" onclick="proceedToPayment()">ì‹ ì²­ ì™„ë£Œí•˜ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- í‘¸í„° -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ì‚¬ì´ë“œí”½</h3>
                    <p>ì •ì¹˜ ì„±í–¥ ê¸°ë°˜ ì˜¤í”„ë¼ì¸ ë§Œë‚¨ ì„œë¹„ìŠ¤</p>
                </div>
                <div class="footer-section">
                    <h4>ì„œë¹„ìŠ¤</h4>
                    <ul>
                        <li><a href="political-test.html">ì„±í–¥ í…ŒìŠ¤íŠ¸</a></li>
                        <li><a href="meeting-schedule.html">ëª¨ì„ ì¼ì •</a></li>
                        <li><a href="index.html#faq">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>ê³ ê°ì„¼í„°</h4>
                    <ul>
                        <li>í‰ì¼ 10:00 - 18:00</li>
                        <li><a href="mailto:clsrna3@naver.com">clsrna3@naver.com</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>ì •ì±…</h4>
                    <ul>
                        <li><a href="terms.html">ì´ìš©ì•½ê´€</a></li>
                        <li><a href="privacy.html">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a></li>
                        <li><a href="refund.html">í™˜ë¶ˆì •ì±…</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 ì‚¬ì´ë“œí”½. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì •ë³´ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', async function() {
            // URLì—ì„œ bookingId ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');
            
            let bookingInfo = null;
            let userProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
            
            try {
                // Firebase APIì—ì„œ ì‚¬ìš©ì ëª¨ì„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const token = localStorage.getItem('authToken');
                const API_URL = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3000' 
                    : 'https://sidepick.onrender.com';
                    
                const response = await fetch(`${API_URL}/api/user/meetings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Firebaseì—ì„œ ë°›ì€ ëª¨ì„ ë°ì´í„°:', data);
                    
                    if (data.meetings && data.meetings.length > 0) {
                        // ê°€ì¥ ìµœê·¼ ì‹ ì²­í•œ ëª¨ì„ ì°¾ê¸°
                        const latestMeeting = data.meetings
                            .filter(m => m.status !== 'cancelled')
                            .sort((a, b) => new Date(b.appliedAt) - new Date(a.appliedAt))[0];
                        
                        if (latestMeeting) {
                            bookingInfo = {
                                meetingId: latestMeeting.id || latestMeeting.meetingId,
                                title: latestMeeting.title,
                                date: latestMeeting.date,
                                location: latestMeeting.location,
                                time: latestMeeting.time,
                                orientation: latestMeeting.orientation,
                                status: latestMeeting.status
                            };
                            console.log('ì„ íƒëœ ëª¨ì„:', bookingInfo);
                        }
                    }
                }
            } catch (error) {
                console.error('Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            
            // Firebaseì—ì„œ ë°ì´í„°ë¥¼ ëª» ê°€ì ¸ì˜¨ ê²½ìš° sessionStorage í™•ì¸
            if (!bookingInfo) {
                // URL íŒŒë¼ë¯¸í„° í™•ì¸ (ìƒˆë¡œ ì‹ ì²­í•˜ëŠ” ê²½ìš°)
                const orientation = urlParams.get('orientation');
                const reapply = urlParams.get('reapply');
                
                console.log('URL params:', { bookingId, orientation, reapply });
                
                // ê¸°ì¡´ ë°©ì‹ - pendingBooking ë¨¼ì € í™•ì¸, ì—†ìœ¼ë©´ selectedMeeting
                const pendingBooking = sessionStorage.getItem('pendingBooking');
                const selectedMeeting = sessionStorage.getItem('selectedMeeting');
                
                console.log('SessionStorage data:', {
                    pendingBooking: pendingBooking ? 'exists' : 'null',
                    selectedMeeting: selectedMeeting ? 'exists' : 'null'
                });
                
                if (pendingBooking) {
                    try {
                        bookingInfo = JSON.parse(pendingBooking);
                        console.log('Using pendingBooking:', bookingInfo);
                    } catch (e) {
                        console.error('pendingBooking parse error:', e);
                    }
                } else if (selectedMeeting) {
                    try {
                        // selectedMeetingì—ì„œ ê°€ì ¸ì˜¨ ê²½ìš° í˜•ì‹ ë§ì¶”ê¸°
                        const meeting = JSON.parse(selectedMeeting);
                        console.log('Using selectedMeeting:', meeting);
                        bookingInfo = {
                            meetingId: meeting.id || meeting.meetingId || `meeting_${Date.now()}`,
                            title: meeting.title,
                            date: meeting.date,
                            location: meeting.location,
                            orientation: meeting.orientation || orientation
                        };
                        // pendingBookingì—ë„ ì €ì¥
                        sessionStorage.setItem('pendingBooking', JSON.stringify(bookingInfo));
                    } catch (e) {
                        console.error('selectedMeeting parse error:', e);
                    }
                } else if (orientation) {
                    // URLì— orientationì´ ìˆìœ¼ë©´ ê¸°ë³¸ ì •ë³´ ìƒì„±
                    console.log('Creating default booking info from URL orientation:', orientation);
                    bookingInfo = {
                        meetingId: `meeting_${orientation}_${Date.now()}`,
                        title: `${orientation === 'progressive' ? 'ì§„ë³´' : 'ë³´ìˆ˜'} ì„±í–¥ ì†Œê°œíŒ…`,
                        date: '8ì›” 23ì¼ í† ìš”ì¼',
                        location: 'ê°•ë‚¨ì—­ íŒŒí‹°ë£¸',
                        orientation: orientation
                    };
                    // sessionStorageì— ì €ì¥
                    sessionStorage.setItem('pendingBooking', JSON.stringify(bookingInfo));
                    sessionStorage.setItem('selectedMeeting', JSON.stringify(bookingInfo));
                } else {
                    // appliedMeetingsì—ì„œ ì‹œë„
                    const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
                    const currentOrientation = sessionStorage.getItem('currentOrientation') || 'progressive';
                    
                    console.log('Checking appliedMeetings:', appliedMeetings);
                    
                    if (appliedMeetings[currentOrientation]) {
                        const meetingData = appliedMeetings[currentOrientation];
                        bookingInfo = {
                            meetingId: meetingData.meetingId,
                            title: meetingData.title || `${currentOrientation === 'progressive' ? 'ì§„ë³´' : 'ë³´ìˆ˜'} ì„±í–¥ ëª¨ì„`,
                            date: meetingData.date || 'ë‚ ì§œ ë¯¸ì •',
                            location: meetingData.location || 'ì¥ì†Œ ë¯¸ì •',
                            orientation: currentOrientation
                        };
                        console.log('Using appliedMeetings:', bookingInfo);
                    }
                }
            }
            
            if (!bookingInfo || !bookingInfo.meetingId) {
                alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = 'meeting-schedule.html';
                return;
            }
            
            // ëª¨ì„ ì •ë³´ í‘œì‹œ
            document.getElementById('meeting-title').textContent = bookingInfo.title || 'ëª¨ì„';
            document.getElementById('meeting-date').textContent = bookingInfo.date || 'ë‚ ì§œ ë¯¸ì •';
            document.getElementById('meeting-location').textContent = bookingInfo.location || 'ì¥ì†Œ ë¯¸ì •';
            
            // ì‹ ì²­ì ì •ë³´ í‘œì‹œ (input í•„ë“œì— ê°’ ì„¤ì •)
            document.getElementById('applicant-name').value = userProfile.name || '';
            document.getElementById('applicant-phone').value = userProfile.phone || '';
            document.getElementById('applicant-email').value = sessionStorage.getItem('userEmail') || '';
            
            // pendingBookingì— ì •ë³´ ì €ì¥ (ê²°ì œ í˜ì´ì§€ë¥¼ ìœ„í•´)
            sessionStorage.setItem('pendingBooking', JSON.stringify(bookingInfo));
        });

        // ê²°ì œ ì§„í–‰í•˜ê¸°
        async function proceedToPayment() {
            const agreeCheckbox = document.getElementById('agree-checkbox');
            
            if (!agreeCheckbox.checked) {
                alert('í™˜ë¶ˆ ì •ì±…ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì°¸ê°€ì ì •ë³´ ì €ì¥
            const participantInfo = {
                name: document.getElementById('applicant-name').value,
                phone: document.getElementById('applicant-phone').value,
                email: document.getElementById('applicant-email').value,
                timestamp: new Date().toISOString()
            };
            sessionStorage.setItem('participantInfo', JSON.stringify(participantInfo));
            
            // selectedMeeting í™•ì¸ ë° ì—…ë°ì´íŠ¸
            const bookingInfo = JSON.parse(sessionStorage.getItem('pendingBooking') || '{}');
            const selectedMeeting = {
                id: bookingInfo.meetingId || `meeting_${Date.now()}`,
                title: bookingInfo.title || document.getElementById('meeting-title').textContent,
                date: bookingInfo.date || document.getElementById('meeting-date').textContent,
                time: bookingInfo.time || '15:00',
                location: bookingInfo.location || document.getElementById('meeting-location').textContent,
                orientation: bookingInfo.orientation || 'progressive'
            };
            sessionStorage.setItem('selectedMeeting', JSON.stringify(selectedMeeting));
            
            const authToken = localStorage.getItem('authToken');
            const API_URL = window.location.hostname === 'localhost' 
                ? 'http://localhost:3000' 
                : 'https://sidepick.onrender.com';
            
            // ë¨¼ì € ê¸°ì¡´ ì˜ˆì•½ì´ ìˆëŠ”ì§€ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            let existingBookingId = urlParams.get('bookingId');
            
            if (!existingBookingId) {
                // URLì— bookingIdê°€ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ í™•ì¸
                try {
                    const userMeetingsResponse = await fetch(`${API_URL}/api/user/meetings`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (userMeetingsResponse.ok) {
                        const data = await userMeetingsResponse.json();
                        if (data.meetings && data.meetings.length > 0) {
                            // ê°™ì€ orientationì˜ í™œì„± ì˜ˆì•½ ì°¾ê¸°
                            const activeBooking = data.meetings.find(m => 
                                m.orientation === selectedMeeting.orientation && 
                                (m.status === 'pending' || m.status === 'payment_pending')
                            );
                            
                            if (activeBooking) {
                                existingBookingId = activeBooking.id;
                                console.log('ê¸°ì¡´ ì˜ˆì•½ ë°œê²¬:', existingBookingId, activeBooking.status);
                            }
                        }
                    }
                } catch (error) {
                    console.error('ê¸°ì¡´ ì˜ˆì•½ í™•ì¸ ì‹¤íŒ¨:', error);
                }
            }
            
            // ê¸°ì¡´ ì˜ˆì•½ì´ ìˆìœ¼ë©´ ë°”ë¡œ ê²°ì œ í˜ì´ì§€ë¡œ
            if (existingBookingId) {
                sessionStorage.setItem('currentBookingId', existingBookingId);
                window.location.href = `payment.html?bookingId=${existingBookingId}`;
                return;
            }
            
            // ê¸°ì¡´ ì˜ˆì•½ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            try {
                const response = await fetch(`${API_URL}/api/meetings/apply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        meetingId: selectedMeeting.id,
                        orientation: selectedMeeting.orientation,
                        meetingInfo: {
                            title: selectedMeeting.title,
                            date: selectedMeeting.date,
                            time: selectedMeeting.time,
                            location: selectedMeeting.location
                        },
                        applicationData: participantInfo
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ì˜ˆì•½ ìƒì„± ì‹¤íŒ¨');
                }
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.bookingId) {
                    // ì˜ˆì•½ IDë¥¼ ì„¸ì…˜ì— ì €ì¥
                    sessionStorage.setItem('currentBookingId', result.data.bookingId);
                    // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = `payment.html?bookingId=${result.data.bookingId}`;
                } else {
                    throw new Error('ì˜ˆì•½ IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('ì˜ˆì•½ ìƒì„± ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
    </script>
</body>
</html>