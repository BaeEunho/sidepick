<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>예약 확인 - 사이드픽</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="booking-confirm-styles.css">
    <script src="auth-system.js"></script>
    <script src="auth-check.js"></script>
    <script src="api-client.js"></script>
    <!-- data-system.js 제거 - Firebase 직접 사용 -->
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="index.html">사이드픽</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html#intro">서비스 소개</a></li>
                <li><a href="index.html#test">성향 테스트</a></li>
                <li><a href="meeting-schedule.html">소개팅 일정</a></li>
                <li><a href="index.html#faq">FAQ</a></li>
            </ul>
            <div class="auth-buttons">
                <!-- AuthManager가 자동으로 채워줌 -->
            </div>
        </nav>
    </header>

    <!-- 예약 확인 섹션 -->
    <section class="booking-confirm-section">
        <div class="container">
            <div class="booking-header">
                <h1>예약 확인</h1>
                <p>선택하신 모임 정보를 확인하고 신청을 완료해주세요</p>
            </div>
            
            <div class="booking-content">
                <!-- 모임 정보 -->
                <div class="selected-meeting-info">
                    <h2>선택한 소개팅 정보</h2>
                    <div class="meeting-detail-card">
                        <div class="detail-row">
                            <span class="label">모임 이름</span>
                            <span class="value" id="meeting-title">로딩 중...</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">날짜</span>
                            <span class="value" id="meeting-date">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">장소</span>
                            <span class="value" id="meeting-location">-</span>
                        </div>
                        <div class="detail-row highlight">
                            <span class="label">참가비</span>
                            <span class="value price">45,000원</span>
                        </div>
                    </div>
                </div>

                <!-- 참가자 정보 -->
                <div class="participant-form-section">
                    <h2>참가자 정보</h2>
                    <div class="info-auto-fill">
                        ℹ️ 회원 정보로 자동 입력되었습니다
                    </div>
                    
                    <form class="participant-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="applicant-name">이름</label>
                                <input type="text" id="applicant-name" class="auto-filled" readonly>
                            </div>
                            <div class="form-group">
                                <label for="applicant-phone">연락처</label>
                                <input type="tel" id="applicant-phone" class="auto-filled" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="applicant-email">이메일</label>
                            <input type="email" id="applicant-email" class="auto-filled" readonly>
                        </div>
                    </form>

                    <!-- 약관 동의 -->
                    <div class="terms-section">
                        <h3>약관 동의</h3>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="agree-checkbox" required>
                                <span>환불 정책을 확인했으며, 이에 동의합니다 (필수)</span>
                            </label>
                        </div>
                    </div>

                    <!-- 안내사항 -->
                    <div class="notice-section">
                        <h3>📌 환불 정책 안내</h3>
                        <ul>
                            <li>모임 3일 전까지: 100% 환불</li>
                            <li>모임 2일 전: 70% 환불</li>
                            <li>모임 1일 전: 50% 환불</li>
                            <li>모임 당일: 환불 불가</li>
                        </ul>
                    </div>

                    <!-- 버튼 영역 -->
                    <div class="button-group">
                        <button class="btn-secondary" onclick="history.back()">이전으로</button>
                        <button class="btn-primary" id="proceed-payment" onclick="proceedToPayment()">신청 완료하기</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 푸터 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>사이드픽</h3>
                    <p>정치 성향 기반 오프라인 만남 서비스</p>
                </div>
                <div class="footer-section">
                    <h4>서비스</h4>
                    <ul>
                        <li><a href="political-test.html">성향 테스트</a></li>
                        <li><a href="meeting-schedule.html">모임 일정</a></li>
                        <li><a href="index.html#faq">자주 묻는 질문</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>고객센터</h4>
                    <ul>
                        <li>평일 10:00 - 18:00</li>
                        <li><a href="mailto:clsrna3@naver.com">clsrna3@naver.com</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>정책</h4>
                    <ul>
                        <li><a href="terms.html">이용약관</a></li>
                        <li><a href="privacy.html">개인정보처리방침</a></li>
                        <li><a href="refund.html">환불정책</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 사이드픽. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // 페이지 로드 시 정보 표시
        document.addEventListener('DOMContentLoaded', async function() {
            // URL에서 bookingId 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');
            
            let bookingInfo = null;
            let userProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
            
            try {
                // Firebase API에서 사용자 모임 정보 가져오기
                const token = localStorage.getItem('authToken');
                const API_URL = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3000' 
                    : 'https://sidepick.onrender.com';
                    
                const response = await fetch(`${API_URL}/api/user/meetings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Firebase에서 받은 모임 데이터:', data);
                    
                    if (data.meetings && data.meetings.length > 0) {
                        // 가장 최근 신청한 모임 찾기
                        const latestMeeting = data.meetings
                            .filter(m => m.status !== 'cancelled')
                            .sort((a, b) => new Date(b.appliedAt) - new Date(a.appliedAt))[0];
                        
                        if (latestMeeting) {
                            bookingInfo = {
                                meetingId: latestMeeting.id || latestMeeting.meetingId,
                                title: latestMeeting.title,
                                date: latestMeeting.date,
                                location: latestMeeting.location,
                                time: latestMeeting.time,
                                orientation: latestMeeting.orientation,
                                status: latestMeeting.status
                            };
                            console.log('선택된 모임:', bookingInfo);
                        }
                    }
                }
            } catch (error) {
                console.error('Firebase 데이터 로드 실패:', error);
            }
            
            // Firebase에서 데이터를 못 가져온 경우 sessionStorage 확인
            if (!bookingInfo) {
                // URL 파라미터 확인 (새로 신청하는 경우)
                const orientation = urlParams.get('orientation');
                const reapply = urlParams.get('reapply');
                
                console.log('URL params:', { bookingId, orientation, reapply });
                
                // 기존 방식 - pendingBooking 먼저 확인, 없으면 selectedMeeting
                const pendingBooking = sessionStorage.getItem('pendingBooking');
                const selectedMeeting = sessionStorage.getItem('selectedMeeting');
                
                console.log('SessionStorage data:', {
                    pendingBooking: pendingBooking ? 'exists' : 'null',
                    selectedMeeting: selectedMeeting ? 'exists' : 'null'
                });
                
                if (pendingBooking) {
                    try {
                        bookingInfo = JSON.parse(pendingBooking);
                        console.log('Using pendingBooking:', bookingInfo);
                    } catch (e) {
                        console.error('pendingBooking parse error:', e);
                    }
                } else if (selectedMeeting) {
                    try {
                        // selectedMeeting에서 가져온 경우 형식 맞추기
                        const meeting = JSON.parse(selectedMeeting);
                        console.log('Using selectedMeeting:', meeting);
                        bookingInfo = {
                            meetingId: meeting.id || meeting.meetingId || `meeting_${Date.now()}`,
                            title: meeting.title,
                            date: meeting.date,
                            location: meeting.location,
                            orientation: meeting.orientation || orientation
                        };
                        // pendingBooking에도 저장
                        sessionStorage.setItem('pendingBooking', JSON.stringify(bookingInfo));
                    } catch (e) {
                        console.error('selectedMeeting parse error:', e);
                    }
                } else if (orientation) {
                    // URL에 orientation이 있으면 기본 정보 생성
                    console.log('Creating default booking info from URL orientation:', orientation);
                    bookingInfo = {
                        meetingId: `meeting_${orientation}_${Date.now()}`,
                        title: `${orientation === 'progressive' ? '진보' : '보수'} 성향 소개팅`,
                        date: '8월 23일 토요일',
                        location: '강남역 파티룸',
                        orientation: orientation
                    };
                    // sessionStorage에 저장
                    sessionStorage.setItem('pendingBooking', JSON.stringify(bookingInfo));
                    sessionStorage.setItem('selectedMeeting', JSON.stringify(bookingInfo));
                } else {
                    // appliedMeetings에서 시도
                    const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
                    const currentOrientation = sessionStorage.getItem('currentOrientation') || 'progressive';
                    
                    console.log('Checking appliedMeetings:', appliedMeetings);
                    
                    if (appliedMeetings[currentOrientation]) {
                        const meetingData = appliedMeetings[currentOrientation];
                        bookingInfo = {
                            meetingId: meetingData.meetingId,
                            title: meetingData.title || `${currentOrientation === 'progressive' ? '진보' : '보수'} 성향 모임`,
                            date: meetingData.date || '날짜 미정',
                            location: meetingData.location || '장소 미정',
                            orientation: currentOrientation
                        };
                        console.log('Using appliedMeetings:', bookingInfo);
                    }
                }
            }
            
            if (!bookingInfo || !bookingInfo.meetingId) {
                alert('예약 정보를 찾을 수 없습니다.');
                window.location.href = 'meeting-schedule.html';
                return;
            }
            
            // 모임 정보 표시
            document.getElementById('meeting-title').textContent = bookingInfo.title || '모임';
            document.getElementById('meeting-date').textContent = bookingInfo.date || '날짜 미정';
            document.getElementById('meeting-location').textContent = bookingInfo.location || '장소 미정';
            
            // 신청자 정보 표시 (input 필드에 값 설정)
            document.getElementById('applicant-name').value = userProfile.name || '';
            document.getElementById('applicant-phone').value = userProfile.phone || '';
            document.getElementById('applicant-email').value = sessionStorage.getItem('userEmail') || '';
            
            // pendingBooking에 정보 저장 (결제 페이지를 위해)
            sessionStorage.setItem('pendingBooking', JSON.stringify(bookingInfo));
        });

        // 결제 진행하기
        async function proceedToPayment() {
            const agreeCheckbox = document.getElementById('agree-checkbox');
            
            if (!agreeCheckbox.checked) {
                alert('환불 정책에 동의해주세요.');
                return;
            }
            
            // 참가자 정보 저장
            const participantInfo = {
                name: document.getElementById('applicant-name').value,
                phone: document.getElementById('applicant-phone').value,
                email: document.getElementById('applicant-email').value,
                timestamp: new Date().toISOString()
            };
            sessionStorage.setItem('participantInfo', JSON.stringify(participantInfo));
            
            // selectedMeeting 확인 및 업데이트
            const bookingInfo = JSON.parse(sessionStorage.getItem('pendingBooking') || '{}');
            const selectedMeeting = {
                id: bookingInfo.meetingId || `meeting_${Date.now()}`,
                title: bookingInfo.title || document.getElementById('meeting-title').textContent,
                date: bookingInfo.date || document.getElementById('meeting-date').textContent,
                time: bookingInfo.time || '15:00',
                location: bookingInfo.location || document.getElementById('meeting-location').textContent,
                orientation: bookingInfo.orientation || 'progressive'
            };
            sessionStorage.setItem('selectedMeeting', JSON.stringify(selectedMeeting));
            
            const authToken = localStorage.getItem('authToken');
            const API_URL = window.location.hostname === 'localhost' 
                ? 'http://localhost:3000' 
                : 'https://sidepick.onrender.com';
            
            // 먼저 기존 예약이 있는지 확인
            const urlParams = new URLSearchParams(window.location.search);
            let existingBookingId = urlParams.get('bookingId');
            
            if (!existingBookingId) {
                // URL에 bookingId가 없으면 서버에서 확인
                try {
                    const userMeetingsResponse = await fetch(`${API_URL}/api/user/meetings`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (userMeetingsResponse.ok) {
                        const data = await userMeetingsResponse.json();
                        if (data.meetings && data.meetings.length > 0) {
                            // 같은 orientation의 활성 예약 찾기
                            const activeBooking = data.meetings.find(m => 
                                m.orientation === selectedMeeting.orientation && 
                                (m.status === 'pending' || m.status === 'payment_pending')
                            );
                            
                            if (activeBooking) {
                                existingBookingId = activeBooking.id;
                                console.log('기존 예약 발견:', existingBookingId, activeBooking.status);
                            }
                        }
                    }
                } catch (error) {
                    console.error('기존 예약 확인 실패:', error);
                }
            }
            
            // 기존 예약이 있으면 바로 결제 페이지로
            if (existingBookingId) {
                sessionStorage.setItem('currentBookingId', existingBookingId);
                window.location.href = `payment.html?bookingId=${existingBookingId}`;
                return;
            }
            
            // 기존 예약이 없으면 새로 생성
            try {
                const response = await fetch(`${API_URL}/api/meetings/apply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        meetingId: selectedMeeting.id,
                        orientation: selectedMeeting.orientation,
                        meetingInfo: {
                            title: selectedMeeting.title,
                            date: selectedMeeting.date,
                            time: selectedMeeting.time,
                            location: selectedMeeting.location
                        },
                        applicationData: participantInfo
                    })
                });
                
                if (!response.ok) {
                    throw new Error('예약 생성 실패');
                }
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.bookingId) {
                    // 예약 ID를 세션에 저장
                    sessionStorage.setItem('currentBookingId', result.data.bookingId);
                    // 결제 페이지로 이동
                    window.location.href = `payment.html?bookingId=${result.data.bookingId}`;
                } else {
                    throw new Error('예약 ID를 받지 못했습니다');
                }
                
            } catch (error) {
                console.error('예약 생성 오류:', error);
                alert('예약 생성에 실패했습니다. 다시 시도해주세요.');
            }
        }
    </script>
</body>
</html>