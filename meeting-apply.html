<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¨ì„ ì‹ ì²­ - ì‚¬ì´ë“œí”½</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="apply-styles.css">
    <script src="auth-check.js"></script>
    <script src="api-client.js"></script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="index.html">ì‚¬ì´ë“œí”½</a>
            </div>
            <div class="auth-buttons">
                <span class="user-name" id="user-name-display"></span>
                <a href="mypage.html" class="mypage-btn">ë§ˆì´í˜ì´ì§€</a>
            </div>
        </nav>
    </header>

    <!-- ëª¨ì„ ì‹ ì²­ ì„¹ì…˜ -->
    <section class="apply-section">
        <div class="container">
            <h1>ëª¨ì„ ì‹ ì²­í•˜ê¸°</h1>
            
            <!-- ëª¨ì„ ì •ë³´ ì¹´ë“œ -->
            <div class="meeting-info-card">
                <h2>ì§„ë³´ ê°œí˜í˜• Ã— ì‚¬íšŒ ë³µì§€í˜•</h2>
                <div class="meeting-info-grid">
                    <div class="info-item">
                        <span class="info-label">ë‚ ì§œ</span>
                        <span class="info-value">12ì›” 7ì¼ (í† ) 15:00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì¥ì†Œ</span>
                        <span class="info-value">ê°•ë‚¨ì—­ íŒŒí‹°ë£¸</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì°¸ê°€ë¹„</span>
                        <span class="info-value">45,000ì›</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì—°ë ¹ëŒ€</span>
                        <span class="info-value">25-32ì„¸</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">í˜„ì¬ ì‹ ì²­ í˜„í™©</span>
                        <span class="info-value">ë‚¨ì„± 2/4, ì—¬ì„± 3/4</span>
                    </div>
                </div>
            </div>

            <!-- ì‹ ì²­ ì–‘ì‹ -->
            <form class="apply-form" onsubmit="handleApply(event)">
                <div class="form-section">
                    <h3>ê¸°ë³¸ ì •ë³´</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">ì´ë¦„</label>
                            <input type="text" id="name" name="name" value="" readonly>
                        </div>
                        <div class="form-group">
                            <label for="age">ë‚˜ì´</label>
                            <input type="text" id="age" name="age" value="" readonly>
                        </div>
                        <div class="form-group">
                            <label for="gender">ì„±ë³„</label>
                            <input type="text" id="gender" name="gender" value="" readonly>
                        </div>
                        <div class="form-group">
                            <label for="type">ì •ì¹˜ ì„±í–¥</label>
                            <input type="text" id="type" name="type" value="" readonly>
                        </div>
                    </div>
                </div>


                <div class="form-section">
                    <h3>ê²°ì œ ì •ë³´</h3>
                    <div class="payment-info">
                        <div class="payment-row">
                            <span>ì°¸ê°€ë¹„</span>
                            <span>45,000ì›</span>
                        </div>
                        <div class="payment-divider"></div>
                        <div class="payment-row total">
                            <span>ì´ ê²°ì œê¸ˆì•¡</span>
                            <span>45,000ì›</span>
                        </div>
                    </div>
                    
                    <div class="payment-method">
                        <label>ê²°ì œ ìˆ˜ë‹¨</label>
                        <div class="payment-notice">
                            <p>í˜„ì¬ ë¬´í†µì¥ ì…ê¸ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                            <div class="bank-info">
                                <div class="bank-row">
                                    <span>ì€í–‰ëª…:</span>
                                    <span>êµ­ë¯¼ì€í–‰</span>
                                </div>
                                <div class="bank-row">
                                    <span>ê³„ì¢Œë²ˆí˜¸:</span>
                                    <span>123-456-789012</span>
                                </div>
                                <div class="bank-row">
                                    <span>ì˜ˆê¸ˆì£¼:</span>
                                    <span>(ì£¼)ì‚¬ì´ë“œí”½</span>
                                </div>
                            </div>
                            <p class="payment-alert">âš ï¸ ì‹ ì²­ í›„ 24ì‹œê°„ ì´ë‚´ì— ì…ê¸ˆí•´ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤.</p>
                            <p class="payment-alert">âš ï¸ ì…ê¸ˆ í™•ì¸ í›„ ì°¸ê°€ í™•ì • ë¬¸ìê°€ ë°œì†¡ë©ë‹ˆë‹¤.</p>
                        </div>
                        <input type="hidden" name="payment" value="bank">
                    </div>
                </div>

                <div class="terms-agree">
                    <label class="checkbox-label">
                        <input type="checkbox" required>
                        <span>í™˜ë¶ˆ ì •ì±…ì„ í™•ì¸í–ˆìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤</span>
                        <a href="#" onclick="showRefundPolicy(event)">ì •ì±… ë³´ê¸°</a>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" required>
                        <span>ë…¸ì‡¼ ì‹œ í–¥í›„ ëª¨ì„ ì°¸ì—¬ê°€ ì œí•œë  ìˆ˜ ìˆìŒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤</span>
                    </label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="submit-btn">ì‹ ì²­í•˜ê¸°</button>
                    <button type="button" class="cancel-btn" onclick="history.back()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </section>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            // ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ í™•ì¸ (ì„±í–¥ í…ŒìŠ¤íŠ¸ê¹Œì§€ ì™„ë£Œí•œ ì‚¬ìš©ì)
            if (!AuthManager.checkPageAccess('verified')) {
                return; // checkPageAccessê°€ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬í•¨
            }
            
            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const userState = AuthManager.getUserState();
            
            // í—¤ë”ì— ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
            const userNameDisplay = document.getElementById('user-name-display');
            if (userNameDisplay && userState.profile && userState.profile.name) {
                userNameDisplay.textContent = userState.profile.name + 'ë‹˜';
            }
            
            // ê¸°ë³¸ ì •ë³´ í•„ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('name').value = userState.profile.name || '';
            
            // ë‚˜ì´ ê³„ì‚° (ìƒë…„ì›”ì¼ë¡œë¶€í„°)
            const birthDate = userState.profile.birthdate ? new Date(userState.profile.birthdate) : null;
            if (birthDate) {
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                const dayDiff = today.getDate() - birthDate.getDate();
                const actualAge = (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) ? age - 1 : age;
                document.getElementById('age').value = actualAge + 'ì„¸';
            } else {
                document.getElementById('age').value = 'ì •ë³´ ì—†ìŒ';
            }
            
            document.getElementById('gender').value = userState.profile.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±';
            
            // ì •ì¹˜ ì„±í–¥ ì •ë³´ í‘œì‹œ
            const politicalType = JSON.parse(sessionStorage.getItem('userType') || '{}');
            document.getElementById('type').value = politicalType.title || 'ì •ë³´ ì—†ìŒ';
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ëª¨ì„ íƒ€ì… ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const meetingType = urlParams.get('type');
            
            // ëª¨ì„ íƒ€ì…ì— ë”°ë¼ ì •ë³´ ì—…ë°ì´íŠ¸ (í•„ìš”í•œ ê²½ìš°)
            updateMeetingInfo(meetingType);
        });
        
        
        // ëª¨ì„ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateMeetingInfo(type) {
            const meetingData = {
                'progressive': {
                    title: 'ì§„ë³´ ê°œí˜í˜• Ã— ì‚¬íšŒ ë³µì§€í˜•',
                    date: '12ì›” 7ì¼ (í† ) 15:00',
                    location: 'ê°•ë‚¨ì—­ íŒŒí‹°ë£¸',
                    age: '25-32ì„¸',
                    status: 'ë‚¨ì„± 2/4, ì—¬ì„± 3/4'
                },
                'moderate': {
                    title: 'ì¤‘ë„ ì‹¤ìš©í˜• Ã— ê²½ì œ ì„±ì¥í˜•',
                    date: '12ì›” 8ì¼ (ì¼) 14:00',
                    location: 'ê°•ë‚¨ì—­ íŒŒí‹°ë£¸',
                    age: '28-35ì„¸',
                    status: 'ë‚¨ì„± 3/4, ì—¬ì„± 2/4'
                },
                'environment': {
                    title: 'í™˜ê²½ ìš°ì„ í˜• Ã— ê¸€ë¡œë²Œ ì‹œë¯¼í˜•',
                    date: '12ì›” 8ì¼ (ì¼) 18:00',
                    location: 'ê°•ë‚¨ì—­ íŒŒí‹°ë£¸',
                    age: '23-30ì„¸',
                    status: 'ë‚¨ì„± 1/4, ì—¬ì„± 4/4'
                }
            };
            
            if (type && meetingData[type]) {
                const data = meetingData[type];
                document.querySelector('.meeting-info-card h2').textContent = data.title;
                document.querySelector('.info-value:nth-of-type(1)').textContent = data.date;
                document.querySelector('.info-value:nth-of-type(2)').textContent = data.location;
                document.querySelector('.info-value:nth-of-type(4)').textContent = data.age;
                document.querySelector('.info-value:nth-of-type(5)').textContent = data.status;
            }
        }

        async function handleApply(event) {
            event.preventDefault();
            
            // í¼ ë°ì´í„° ìˆ˜ì§‘ (ê²°ì œ ì •ë³´ë§Œ)
            const formData = {
                payment: document.querySelector('input[name="payment"]')?.value || 'bank'
            };
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ í•„ìš”í•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const meetingId = urlParams.get('meetingId') || `meeting-${Date.now()}`;
            const orientation = urlParams.get('orientation') || 'progressive';
            
            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const userState = AuthManager.getUserState();
            const politicalType = sessionStorage.getItem('politicalType');
            
            // ëª¨ì„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í™”ë©´ì—ì„œ)
            const meetingTitle = document.querySelector('.meeting-info-card h2').textContent;
            const meetingDate = document.querySelector('.info-value').textContent;
            const meetingLocation = document.querySelector('.info-value:nth-of-type(2)').textContent;
            
            // API ìš”ì²­ ë°ì´í„° êµ¬ì„±
            const requestData = {
                meetingId: meetingId,
                orientation: orientation,
                meetingInfo: {
                    title: meetingTitle,
                    date: meetingDate,
                    location: meetingLocation
                },
                applicationData: formData
            };
            
            // ë””ë²„ê¹…: ì „ì†¡í•  ë°ì´í„° í™•ì¸
            console.log('=== ëª¨ì„ ì‹ ì²­ ë°ì´í„° ===');
            console.log('Request Data:', requestData);
            console.log('User Email:', userState.profile?.email || sessionStorage.getItem('userEmail'));
            console.log('Political Type:', politicalType);
            console.log('Auth Token:', localStorage.getItem('authToken'));
            
            // ë””ë²„ê¹…: ì „ì†¡ ë°ì´í„° í™•ì¸
            console.log('ëª¨ì„ ì‹ ì²­ ë°ì´í„°:', requestData);
            console.log('ì‚¬ìš©ì ì´ë©”ì¼:', userState.email);
            console.log('ì •ì¹˜ ì„±í–¥:', politicalType);
            console.log('ì¸ì¦ í† í°:', localStorage.getItem('authToken'));
            
            try {
                // ì„œë²„ API í˜¸ì¶œ
                const response = await fetch('http://localhost:3000/api/meetings/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}` // localStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
                    },
                    body: JSON.stringify(requestData)
                });
                
                // ë””ë²„ê¹…: ì„œë²„ ì‘ë‹µ í™•ì¸
                console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', result);
                
                // ì„±ê³µ ì‹œ sessionStorage ì—…ë°ì´íŠ¸ (ë°±ì—…ìš©)
                const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
                appliedMeetings[orientation] = {
                    appliedAt: new Date().toISOString(),
                    status: 'pending',
                    formData: formData,
                    meetingId: meetingId,
                    title: meetingTitle,
                    date: meetingDate,
                    location: meetingLocation,
                    applicationId: result.data?.bookingId || result.bookingId // ì„œë²„ì—ì„œ ë°˜í™˜í•œ ì‹ ì²­ ID
                };
                sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                alert('ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ’³ ë¬´í†µì¥ ì…ê¸ˆ ì•ˆë‚´\nì€í–‰: êµ­ë¯¼ì€í–‰\nê³„ì¢Œ: 123-456-789012\nì˜ˆê¸ˆì£¼: (ì£¼)ì‚¬ì´ë“œí”½\nê¸ˆì•¡: 45,000ì›\n\nâš ï¸ 24ì‹œê°„ ì´ë‚´ ì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\nì…ê¸ˆ í™•ì¸ í›„ ì°¸ê°€ í™•ì • ë¬¸ìë¥¼ ë³´ë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                
                // ì‹ ì²­ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'meeting-schedule.html';
                
            } catch (error) {
                console.error('ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                
                // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ í´ë°±: sessionStorageì—ë§Œ ì €ì¥ (ë°ëª¨ ëª¨ë“œ)
                const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
                appliedMeetings[orientation] = {
                    appliedAt: new Date().toISOString(),
                    status: 'pending',
                    formData: formData,
                    meetingId: meetingId,
                    title: meetingTitle,
                    date: meetingDate,
                    location: meetingLocation,
                    demoMode: true // ë°ëª¨ ëª¨ë“œ í‘œì‹œ
                };
                sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
                
                // ë°ëª¨ ëª¨ë“œ ì•Œë¦¼
                alert('[ë°ëª¨ ëª¨ë“œ]\nì‹ ì²­ì´ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì„œë²„ì— ì €ì¥ë©ë‹ˆë‹¤.\n\nğŸ’³ ë¬´í†µì¥ ì…ê¸ˆ ì•ˆë‚´\nì€í–‰: êµ­ë¯¼ì€í–‰\nê³„ì¢Œ: 123-456-789012\nì˜ˆê¸ˆì£¼: (ì£¼)ì‚¬ì´ë“œí”½\nê¸ˆì•¡: 45,000ì›');
                
                window.location.href = 'meeting-schedule.html';
            }
        }
        
        // í™˜ë¶ˆ ì •ì±… ëª¨ë‹¬ í‘œì‹œ
        function showRefundPolicy(event) {
            event.preventDefault();
            
            // ëª¨ë°”ì¼ì¸ ê²½ìš° ëª¨ë‹¬ë¡œ í‘œì‹œ
            if (window.innerWidth <= 768) {
                const modal = document.createElement('div');
                modal.className = 'policy-modal';
                modal.innerHTML = `
                    <div class="policy-modal-content">
                        <div class="policy-modal-header">
                            <h3>í™˜ë¶ˆ ì •ì±…</h3>
                            <button onclick="this.closest('.policy-modal').remove()" class="close-btn">&times;</button>
                        </div>
                        <div class="policy-modal-body">
                            <h4>1. ì „ì•¡ í™˜ë¶ˆ</h4>
                            <ul>
                                <li>ëª¨ì„ 3ì¼ ì „ê¹Œì§€: 100% í™˜ë¶ˆ</li>
                                <li>ëª¨ì„ ì£¼ìµœ ì¸¡ ì‚¬ì •ìœ¼ë¡œ ì·¨ì†Œ ì‹œ: 100% í™˜ë¶ˆ</li>
                            </ul>
                            
                            <h4>2. ë¶€ë¶„ í™˜ë¶ˆ</h4>
                            <ul>
                                <li>ëª¨ì„ 2ì¼ ì „: 70% í™˜ë¶ˆ</li>
                                <li>ëª¨ì„ 1ì¼ ì „: 50% í™˜ë¶ˆ</li>
                            </ul>
                            
                            <h4>3. í™˜ë¶ˆ ë¶ˆê°€</h4>
                            <ul>
                                <li>ëª¨ì„ ë‹¹ì¼ ì·¨ì†Œ</li>
                                <li>ë¬´ë‹¨ ë¶ˆì°¸(ë…¸ì‡¼)</li>
                            </ul>
                            
                            <h4>4. í™˜ë¶ˆ ë°©ë²•</h4>
                            <p>ì·¨ì†Œ ì‹ ì²­ ì‹œ ë“±ë¡í•˜ì‹  ê³„ì¢Œë¡œ 3-5ì˜ì—…ì¼ ì´ë‚´ í™˜ë¶ˆ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } else {
                // ë°ìŠ¤í¬íƒ‘ì€ ìƒˆ ì°½ìœ¼ë¡œ
                window.open('refund.html', '_blank');
            }
        }
    </script>
</body>
</html>