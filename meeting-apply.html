<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>모임 신청 - 사이드픽</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="apply-styles.css">
    <script src="auth-check.js"></script>
    <script src="api-client.js"></script>
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="index.html">사이드픽</a>
            </div>
            <div class="auth-buttons">
                <span class="user-name" id="user-name-display"></span>
                <a href="mypage.html" class="mypage-btn">마이페이지</a>
            </div>
        </nav>
    </header>

    <!-- 모임 신청 섹션 -->
    <section class="apply-section">
        <div class="container">
            <h1>모임 신청하기</h1>
            
            <!-- 모임 정보 카드 -->
            <div class="meeting-info-card">
                <h2>진보 개혁형 × 사회 복지형</h2>
                <div class="meeting-info-grid">
                    <div class="info-item">
                        <span class="info-label">날짜</span>
                        <span class="info-value">8월 23일 (토) 15:00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">장소</span>
                        <span class="info-value">강남역 파티룸</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">참가비</span>
                        <span class="info-value">45,000원</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">연령대</span>
                        <span class="info-value">25-32세</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">현재 신청 현황</span>
                        <span class="info-value">남성 2/4, 여성 3/4</span>
                    </div>
                </div>
            </div>

            <!-- 신청 양식 -->
            <form class="apply-form" onsubmit="handleApply(event)">
                <div class="form-section">
                    <h3>기본 정보</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">이름</label>
                            <input type="text" id="name" name="name" value="" required>
                        </div>
                        <div class="form-group">
                            <label for="age">나이</label>
                            <input type="text" id="age" name="age" value="" readonly>
                        </div>
                        <div class="form-group">
                            <label for="gender">성별</label>
                            <input type="text" id="gender" name="gender" value="" readonly>
                        </div>
                        <div class="form-group">
                            <label for="type">정치 성향</label>
                            <input type="text" id="type" name="type" value="" readonly>
                        </div>
                    </div>
                </div>


                <div class="form-section">
                    <h3>결제 정보</h3>
                    <div class="payment-info">
                        <div class="payment-row">
                            <span>참가비</span>
                            <span>45,000원</span>
                        </div>
                        <div class="payment-divider"></div>
                        <div class="payment-row total">
                            <span>총 결제금액</span>
                            <span>45,000원</span>
                        </div>
                    </div>
                    
                    <div class="payment-method">
                        <label>결제 수단</label>
                        <div class="payment-notice">
                            <p>현재 무통장 입금만 가능합니다.</p>
                            <div class="bank-info">
                                <div class="bank-row">
                                    <span>은행명:</span>
                                    <span>신한은행</span>
                                </div>
                                <div class="bank-row">
                                    <span>계좌번호:</span>
                                    <span>110386140132</span>
                                </div>
                                <div class="bank-row">
                                    <span>예금주:</span>
                                    <span>배은호</span>
                                </div>
                            </div>
                            <p class="payment-alert">⚠️ 신청 후 24시간 이내에 입금해주셔야 합니다.</p>
                            <p class="payment-alert">⚠️ 입금 확인 후 참가 확정 문자가 발송됩니다.</p>
                        </div>
                        <input type="hidden" name="payment" value="bank">
                    </div>
                </div>

                <div class="terms-agree">
                    <label class="checkbox-label">
                        <input type="checkbox" required>
                        <span>환불 정책을 확인했으며 동의합니다</span>
                        <a href="#" onclick="showRefundPolicy(event)">정책 보기</a>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" required>
                        <span>노쇼 시 향후 모임 참여가 제한될 수 있음을 확인했습니다</span>
                    </label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="submit-btn">신청하기</button>
                    <button type="button" class="cancel-btn" onclick="history.back()">취소</button>
                </div>
            </form>
        </div>
    </section>

    <script>
        // 페이지 로드 시 인증 확인
        document.addEventListener('DOMContentLoaded', async function() {
            // 인증된 사용자인지 확인 (성향 테스트까지 완료한 사용자)
            if (!AuthManager.checkPageAccess('verified')) {
                return; // checkPageAccess가 리다이렉트 처리함
            }
            
            // 사용자 정보 가져오기
            const userState = AuthManager.getUserState();
            
            // 헤더에 사용자 이름 표시
            const userNameDisplay = document.getElementById('user-name-display');
            if (userNameDisplay && userState.profile && userState.profile.name) {
                userNameDisplay.textContent = userState.profile.name + '님';
            }
            
            // 기본 정보 필드 업데이트
            document.getElementById('name').value = userState.profile.name || '';
            
            // 나이 계산 (생년월일로부터)
            const birthDate = userState.profile.birthdate ? new Date(userState.profile.birthdate) : null;
            if (birthDate) {
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                const dayDiff = today.getDate() - birthDate.getDate();
                const actualAge = (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) ? age - 1 : age;
                document.getElementById('age').value = actualAge + '세';
            } else {
                document.getElementById('age').value = '정보 없음';
            }
            
            document.getElementById('gender').value = userState.profile.gender === 'male' ? '남성' : '여성';
            
            // 정치 성향 정보 표시
            const politicalType = JSON.parse(sessionStorage.getItem('userType') || '{}');
            document.getElementById('type').value = politicalType.title || '정보 없음';
            
            // URL 파라미터에서 모임 타입 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            const meetingType = urlParams.get('type');
            const orientation = urlParams.get('orientation');
            
            // 모임 타입에 따라 정보 업데이트 (필요한 경우)
            updateMeetingInfo(meetingType, orientation);
            
            // Firebase에서 참가자 수 가져오기
            await fetchParticipantCounts();
            
            // 참가자 수를 가져온 후 다시 화면 업데이트
            updateMeetingInfo(meetingType, orientation);
        });
        
        // 참가자 수 데이터를 저장할 변수
        let participantCounts = {
            progressive: { male: 0, female: 0 },
            conservative: { male: 0, female: 0 }
        };
        
        // Firebase에서 참가자 수 가져오기
        async function fetchParticipantCounts() {
            try {
                const API_URL = window.location.hostname === 'localhost' ? 
                    'http://localhost:3001' : 'https://sidepick.onrender.com';
                
                const response = await fetch(`${API_URL}/api/meetings/attendance`);
                const data = await response.json();
                
                console.log('meeting-apply.html - 참가자 수 데이터 받음:', data);
                
                if (data.success && data.data) {
                    // 초기화
                    participantCounts = {
                        progressive: { male: 0, female: 0 },
                        conservative: { male: 0, female: 0 }
                    };
                    
                    // 데이터 집계
                    Object.values(data.data).forEach(meeting => {
                        if (meeting.orientation === 'progressive') {
                            participantCounts.progressive.male += meeting.male;
                            participantCounts.progressive.female += meeting.female;
                        } else if (meeting.orientation === 'conservative') {
                            participantCounts.conservative.male += meeting.male;
                            participantCounts.conservative.female += meeting.female;
                        }
                    });
                    
                    console.log('meeting-apply.html - 집계된 참가자 수:', participantCounts);
                    console.log('진보: 남성', participantCounts.progressive.male, '여성', participantCounts.progressive.female);
                    console.log('보수: 남성', participantCounts.conservative.male, '여성', participantCounts.conservative.female);
                }
            } catch (error) {
                console.error('meeting-apply.html - 참가자 수 조회 실패:', error);
                // 실패 시 기본값 사용
            }
        }
        
        // 모임 정보 업데이트 함수
        function updateMeetingInfo(type, orientation) {
            const meetingData = {
                'progressive': {
                    title: '진보 성향 소개팅',
                    date: '8월 23일 (토) 15:00',
                    location: '강남역 파티룸',
                    age: '25-32세'
                },
                'conservative': {
                    title: '보수 성향 소개팅',
                    date: '8월 30일 (토) 15:00',
                    location: '강남역 파티룸',
                    age: '27-35세'
                }
            };
            
            // type이 있으면 상세 정보 사용
            if (type && meetingData[type]) {
                const data = meetingData[type];
                document.querySelector('.meeting-info-card h2').textContent = data.title;
                
                // info-value 요소들을 더 정확하게 선택
                const infoValues = document.querySelectorAll('.meeting-info-card .info-value');
                if (infoValues.length >= 5) {
                    infoValues[0].textContent = data.date;
                    infoValues[1].textContent = data.location;
                    infoValues[3].textContent = data.age;
                    
                    // Firebase에서 가져온 실제 참가자 수 표시
                    const counts = participantCounts[type] || { male: 0, female: 0 };
                    infoValues[4].textContent = `남성 ${counts.male}/4, 여성 ${counts.female}/4`;
                }
            } else if (orientation) {
                // orientation만 있는 경우 일반적인 제목 사용
                const orientationTitles = {
                    'progressive': '진보 성향 모임',
                    'conservative': '보수 성향 모임'
                };
                
                if (orientationTitles[orientation]) {
                    document.querySelector('.meeting-info-card h2').textContent = orientationTitles[orientation];
                }
                
                // orientation에 해당하는 데이터가 있으면 사용
                if (meetingData[orientation]) {
                    const data = meetingData[orientation];
                    const infoValues = document.querySelectorAll('.meeting-info-card .info-value');
                    if (infoValues.length >= 5) {
                        infoValues[0].textContent = data.date;
                        infoValues[1].textContent = data.location;
                        infoValues[3].textContent = data.age;
                        
                        // Firebase에서 가져온 실제 참가자 수 표시
                        const counts = participantCounts[orientation] || { male: 0, female: 0 };
                        infoValues[4].textContent = `남성 ${counts.male}/4, 여성 ${counts.female}/4`;
                    }
                }
            }
        }

        async function handleApply(event) {
            event.preventDefault();
            
            // 폼 데이터 수집 (결제 정보만)
            const formData = {
                payment: document.querySelector('input[name="payment"]')?.value || 'bank'
            };
            
            // URL 파라미터에서 필요한 정보 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            const meetingId = urlParams.get('meetingId') || `meeting-${Date.now()}`;
            const orientation = urlParams.get('orientation') || 'progressive';
            
            console.log('=== CRITICAL DEBUG ===');
            console.log('Current URL:', window.location.href);
            console.log('URL Search:', window.location.search);
            console.log('URL Params:', Object.fromEntries(urlParams.entries()));
            console.log('Meeting ID from URL:', urlParams.get('meetingId'));
            console.log('Orientation from URL:', urlParams.get('orientation'));
            console.log('Final orientation value:', orientation);
            console.log('===================');
            
            // 사용자 정보 가져오기
            const userState = AuthManager.getUserState();
            const politicalType = sessionStorage.getItem('politicalType');
            
            // 모임 정보 가져오기 (화면에서)
            const meetingTitle = document.querySelector('.meeting-info-card h2').textContent;
            const infoValues = document.querySelectorAll('.meeting-info-card .info-value');
            const meetingDate = infoValues[0] ? infoValues[0].textContent : '날짜 미정';
            const meetingLocation = infoValues[1] ? infoValues[1].textContent : '장소 미정';
            
            // API 요청 데이터 구성
            const requestData = {
                meetingId: meetingId,
                orientation: orientation,
                meetingInfo: {
                    title: meetingTitle,
                    date: meetingDate,
                    location: meetingLocation
                },
                applicationData: formData
            };
            
            // 디버깅: 전송할 데이터 확인
            console.log('=== 모임 신청 데이터 ===');
            console.log('Request Data:', requestData);
            console.log('User Email:', userState.profile?.email || sessionStorage.getItem('userEmail'));
            console.log('Political Type:', politicalType);
            const authToken = localStorage.getItem('authToken');
            console.log('Auth Token:', authToken ? `${authToken.substring(0, 20)}...` : 'NO TOKEN');
            console.log('Token exists:', !!authToken);
            console.log('API URL:', 'https://sidepick.onrender.com/api/meetings/apply');
            
            // 디버깅: 전송 데이터 확인
            console.log('모임 신청 데이터:', requestData);
            console.log('사용자 이메일:', userState.email);
            console.log('정치 성향:', politicalType);
            console.log('인증 토큰:', localStorage.getItem('authToken'));
            
            try {
                // 서버 API 호출
                const response = await fetch('https://sidepick.onrender.com/api/meetings/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}` // localStorage에서 토큰 가져오기
                    },
                    body: JSON.stringify(requestData)
                });
                
                // 디버깅: 서버 응답 확인
                console.log('서버 응답 상태:', response.status);
                
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                        console.error('서버 오류 응답:', errorData);
                    } catch (e) {
                        console.error('응답 파싱 실패:', e);
                        errorData = { message: `서버 오류: ${response.status} ${response.statusText}` };
                    }
                    
                    // 서버에서 명시적인 에러 메시지가 있으면 표시
                    if (errorData.message) {
                        alert(errorData.message);
                        return;
                    }
                    
                    throw new Error(`서버 오류: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('서버 응답 데이터:', result);
                
                if (result.success) {
                    console.log('=== API 호출 성공 ===');
                    console.log('Booking ID:', result.data?.bookingId);
                    
                    // appliedMeetings 업데이트 (서버 응답 반영)
                    const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
                    appliedMeetings[orientation] = {
                        appliedAt: new Date().toISOString(),
                        status: 'pending',
                        formData: formData,
                        meetingId: meetingId,
                        title: meetingTitle,
                        date: meetingDate,
                        location: meetingLocation,
                        bookingId: result.data?.bookingId || `booking_${Date.now()}`
                    };
                    sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
                    console.log('Saved appliedMeetings:', appliedMeetings);
                    
                    // 예약 정보를 pendingBooking에 저장
                    const bookingInfo = {
                        meetingId: meetingId,
                        title: meetingTitle,
                        date: meetingDate,
                        location: meetingLocation,
                        orientation: orientation,
                        bookingId: result.data?.bookingId || `booking_${Date.now()}`
                    };
                    sessionStorage.setItem('pendingBooking', JSON.stringify(bookingInfo));
                    
                    alert('모임 신청이 완료되었습니다!');
                    
                    // 예약 확인 페이지로 이동 (약간의 지연을 주어 sessionStorage 저장 보장)
                    setTimeout(() => {
                        window.location.href = 'booking-confirm.html';
                    }, 100);
                } else {
                    console.error('API 응답 실패:', result.message);
                    alert(`모임 신청 실패: ${result.message}`);
                }
                
            } catch (error) {
                console.error('신청 처리 중 오류:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // 사용자에게 더 자세한 에러 메시지 표시
                alert(`모임 신청 중 오류가 발생했습니다.\n\n오류: ${error.message}\n\n문제가 계속되면 관리자에게 문의해주세요.`);
                
                // API 호출 실패 시 폴백: sessionStorage에만 저장 (데모 모드)
                const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
                appliedMeetings[orientation] = {
                    appliedAt: new Date().toISOString(),
                    status: 'pending',
                    formData: formData,
                    meetingId: meetingId,
                    title: meetingTitle,
                    date: meetingDate,
                    location: meetingLocation,
                    demoMode: true // 데모 모드 표시
                };
                sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
                console.log('Saved appliedMeetings (demo mode):', appliedMeetings);
                
                // 예약 정보를 pendingBooking에 저장 (데모 모드)
                const bookingInfo = {
                    meetingId: meetingId,
                    title: meetingTitle,
                    date: meetingDate,
                    location: meetingLocation,
                    orientation: orientation,
                    bookingId: `demo_booking_${Date.now()}`,
                    demoMode: true
                };
                sessionStorage.setItem('pendingBooking', JSON.stringify(bookingInfo));
                
                // 예약 확인 페이지로 이동 (약간의 지연을 주어 sessionStorage 저장 보장)
                setTimeout(() => {
                    window.location.href = 'booking-confirm.html';
                }, 100);
            }
        }
        
        // 환불 정책 모달 표시
        function showRefundPolicy(event) {
            event.preventDefault();
            
            // 모바일인 경우 모달로 표시
            if (window.innerWidth <= 768) {
                const modal = document.createElement('div');
                modal.className = 'policy-modal';
                modal.innerHTML = `
                    <div class="policy-modal-content">
                        <div class="policy-modal-header">
                            <h3>환불 정책</h3>
                            <button onclick="this.closest('.policy-modal').remove()" class="close-btn">&times;</button>
                        </div>
                        <div class="policy-modal-body">
                            <h4>1. 전액 환불</h4>
                            <ul>
                                <li>모임 3일 전까지: 100% 환불</li>
                                <li>모임 주최 측 사정으로 취소 시: 100% 환불</li>
                            </ul>
                            
                            <h4>2. 부분 환불</h4>
                            <ul>
                                <li>모임 2일 전: 70% 환불</li>
                                <li>모임 1일 전: 50% 환불</li>
                            </ul>
                            
                            <h4>3. 환불 불가</h4>
                            <ul>
                                <li>모임 당일 취소</li>
                                <li>무단 불참(노쇼)</li>
                            </ul>
                            
                            <h4>4. 환불 방법</h4>
                            <p>취소 신청 시 등록하신 계좌로 3-5영업일 이내 환불 처리됩니다.</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // 모달 외부 클릭 시 닫기
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } else {
                // 데스크탑은 새 창으로
                window.open('refund.html', '_blank');
            }
        }
    </script>
</body>
</html>