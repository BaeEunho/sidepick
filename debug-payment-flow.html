<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Flow Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
        }
        button.danger {
            background: #e74c3c;
        }
        button.success {
            background: #2ecc71;
        }
        pre {
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .flow-step {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 2px solid #ddd;
        }
        .flow-step.active {
            border-color: #3498db;
            background: #e3f2fd;
        }
    </style>
</head>
<body>
    <h1>Payment Flow 디버깅</h1>
    
    <div class="section">
        <h2>현재 상태 확인</h2>
        <button onclick="checkCurrentStatus()">상태 확인</button>
        <pre id="current-status"></pre>
    </div>
    
    <div class="section">
        <h2>결제 플로우 시뮬레이션</h2>
        
        <div class="flow-step" id="step1">
            <h3>1. 신청 완료 (pending)</h3>
            <button onclick="simulateApplication()">신청 시뮬레이션</button>
        </div>
        
        <div class="flow-step" id="step2">
            <h3>2. 결제 안내 완료 (payment_completed)</h3>
            <button onclick="simulatePaymentComplete()">결제 안내 완료 시뮬레이션</button>
        </div>
        
        <div class="flow-step" id="step3">
            <h3>3. 입금 완료 (paid)</h3>
            <button onclick="simulatePaid()">입금 완료 시뮬레이션</button>
        </div>
        
        <div class="flow-step" id="step4">
            <h3>4. 참가 확정 (confirmed)</h3>
            <button onclick="simulateConfirmed()">참가 확정 시뮬레이션</button>
        </div>
    </div>
    
    <div class="section">
        <h2>수동 작업</h2>
        <button class="danger" onclick="resetAll()">모든 신청 초기화</button>
        <button class="success" onclick="fixPaymentCompleted()">payment_completed로 강제 변경</button>
    </div>
    
    <script>
        function checkCurrentStatus() {
            const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
            const selectedMeeting = JSON.parse(sessionStorage.getItem('selectedMeeting') || '{}');
            const participantInfo = JSON.parse(sessionStorage.getItem('participantInfo') || '{}');
            const paymentInfo = JSON.parse(sessionStorage.getItem('paymentInfo') || '{}');
            
            const data = {
                appliedMeetings,
                selectedMeeting,
                participantInfo,
                paymentInfo,
                userEmail: sessionStorage.getItem('userEmail'),
                politicalType: sessionStorage.getItem('politicalType')
            };
            
            document.getElementById('current-status').textContent = JSON.stringify(data, null, 2);
            
            // 현재 상태 하이라이트
            highlightCurrentStep(appliedMeetings);
        }
        
        function highlightCurrentStep(appliedMeetings) {
            // 모든 step 비활성화
            document.querySelectorAll('.flow-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // 현재 상태에 따라 활성화
            const orientation = getOrientation();
            if (appliedMeetings[orientation]) {
                const status = appliedMeetings[orientation].status;
                if (status === 'pending') {
                    document.getElementById('step1').classList.add('active');
                } else if (status === 'payment_completed') {
                    document.getElementById('step2').classList.add('active');
                } else if (status === 'paid') {
                    document.getElementById('step3').classList.add('active');
                } else if (status === 'confirmed') {
                    document.getElementById('step4').classList.add('active');
                }
            }
        }
        
        function getOrientation() {
            const politicalType = sessionStorage.getItem('politicalType');
            const progressiveCodes = ['MPOS', 'MPON', 'MPTS', 'MPTN', 'GPOS', 'GPON', 'GPTS', 'GPTN'];
            return progressiveCodes.includes(politicalType) ? 'progressive' : 'conservative';
        }
        
        function simulateApplication() {
            const orientation = getOrientation();
            const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
            
            appliedMeetings[orientation] = {
                meetingId: `meeting_${orientation}_${Date.now()}`,
                status: 'pending',
                appliedAt: new Date().toISOString()
            };
            
            sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
            alert('신청 완료 상태로 설정되었습니다.');
            checkCurrentStatus();
        }
        
        function simulatePaymentComplete() {
            const orientation = getOrientation();
            const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
            
            if (!appliedMeetings[orientation]) {
                alert('먼저 신청을 해주세요.');
                return;
            }
            
            // payment-complete-script.js의 confirmParticipation 함수 로직 재현
            appliedMeetings[orientation].status = 'payment_completed';
            appliedMeetings[orientation].paymentCompletedAt = new Date().toISOString();
            appliedMeetings[orientation].paymentInfo = {
                orderId: `ORD-${Date.now()}`,
                method: 'transfer'
            };
            
            sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
            alert('결제 안내 완료 상태로 설정되었습니다.');
            checkCurrentStatus();
        }
        
        function simulatePaid() {
            const orientation = getOrientation();
            const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
            
            if (!appliedMeetings[orientation]) {
                alert('먼저 신청을 해주세요.');
                return;
            }
            
            appliedMeetings[orientation].status = 'paid';
            appliedMeetings[orientation].paidAt = new Date().toISOString();
            
            sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
            alert('입금 완료 상태로 설정되었습니다.');
            checkCurrentStatus();
        }
        
        function simulateConfirmed() {
            const orientation = getOrientation();
            const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
            
            if (!appliedMeetings[orientation]) {
                alert('먼저 신청을 해주세요.');
                return;
            }
            
            appliedMeetings[orientation].status = 'confirmed';
            appliedMeetings[orientation].confirmedAt = new Date().toISOString();
            
            sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
            alert('참가 확정 상태로 설정되었습니다.');
            checkCurrentStatus();
        }
        
        function resetAll() {
            if (confirm('정말로 모든 신청을 초기화하시겠습니까?')) {
                sessionStorage.removeItem('appliedMeetings');
                sessionStorage.removeItem('selectedMeeting');
                sessionStorage.removeItem('participantInfo');
                sessionStorage.removeItem('paymentInfo');
                alert('초기화되었습니다.');
                checkCurrentStatus();
            }
        }
        
        function fixPaymentCompleted() {
            const orientation = getOrientation();
            const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
            
            if (!appliedMeetings[orientation]) {
                alert('신청 정보가 없습니다.');
                return;
            }
            
            appliedMeetings[orientation].status = 'payment_completed';
            appliedMeetings[orientation].paymentCompletedAt = new Date().toISOString();
            
            sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
            alert('payment_completed 상태로 강제 변경되었습니다.');
            checkCurrentStatus();
        }
        
        // 페이지 로드 시 자동 실행
        checkCurrentStatus();
    </script>
</body>
</html>