<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conservative Meeting Apply Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
        }
        button:hover {
            opacity: 0.8;
        }
        pre {
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .log {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Conservative Meeting Apply í…ŒìŠ¤íŠ¸</h1>
    
    <div class="section">
        <h2>1. í˜„ì¬ ìƒíƒœ í™•ì¸</h2>
        <button onclick="checkCurrentState()">í˜„ì¬ ìƒíƒœ í™•ì¸</button>
        <pre id="current-state"></pre>
    </div>
    
    <div class="section">
        <h2>2. Conservative ëª¨ì„ ì‹ ì²­ ì‹œë®¬ë ˆì´ì…˜</h2>
        <button onclick="simulateConservativeApply()">Conservative ëª¨ì„ ì‹ ì²­ í…ŒìŠ¤íŠ¸</button>
        <p>ì´ ë²„íŠ¼ì€ index.htmlì˜ ë³´ìˆ˜ ëª¨ì„ ì‹ ì²­ê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.</p>
    </div>
    
    <div class="section">
        <h2>3. API ì§ì ‘ í˜¸ì¶œ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testDirectAPI()">API ì§ì ‘ í˜¸ì¶œ (Conservative)</button>
        <button onclick="testDirectAPI('progressive')">API ì§ì ‘ í˜¸ì¶œ (Progressive)</button>
    </div>
    
    <div class="section">
        <h2>4. Firebase ë°ì´í„° í™•ì¸</h2>
        <button onclick="checkFirebaseData()">Firebase ë°ì´í„° ì¡°íšŒ</button>
        <pre id="firebase-data"></pre>
    </div>
    
    <div class="section">
        <h2>ì‹¤í–‰ ë¡œê·¸</h2>
        <div id="log" class="log"></div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function checkCurrentState() {
            const state = {
                user: {
                    email: sessionStorage.getItem('userEmail'),
                    politicalType: sessionStorage.getItem('politicalType'),
                    gender: sessionStorage.getItem('userGender'),
                    orientation: getOrientationFromPoliticalType()
                },
                auth: {
                    isLoggedIn: sessionStorage.getItem('isLoggedIn'),
                    authToken: !!localStorage.getItem('authToken')
                },
                meetings: JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}')
            };
            
            document.getElementById('current-state').textContent = JSON.stringify(state, null, 2);
            log('í˜„ì¬ ìƒíƒœ í™•ì¸ ì™„ë£Œ');
        }
        
        function getOrientationFromPoliticalType() {
            const politicalType = sessionStorage.getItem('politicalType');
            const progressiveCodes = ['MPOS', 'MPON', 'MPTS', 'MPTN', 'GPOS', 'GPON', 'GPTS', 'GPTN'];
            return progressiveCodes.includes(politicalType) ? 'progressive' : 'conservative';
        }
        
        function simulateConservativeApply() {
            // index.htmlê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ meeting-apply.htmlë¡œ ì´ë™
            const orientation = 'conservative';
            const meetingId = `meeting_${orientation}_${Date.now()}`;
            const url = `meeting-apply.html?meetingId=${meetingId}&orientation=${orientation}`;
            
            log(`Redirecting to: ${url}`);
            log('orientation parameter: ' + orientation, 'warning');
            
            // 3ì´ˆ í›„ ì´ë™
            setTimeout(() => {
                window.location.href = url;
            }, 3000);
        }
        
        async function testDirectAPI(orientation = 'conservative') {
            log(`=== API ì§ì ‘ í˜¸ì¶œ í…ŒìŠ¤íŠ¸: ${orientation} ===`);
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                log('Auth tokenì´ ì—†ìŠµë‹ˆë‹¤!', 'error');
                return;
            }
            
            const API_URL = window.location.hostname === 'localhost' 
                ? 'http://localhost:3001' 
                : 'https://sidepick.onrender.com';
            
            const requestData = {
                meetingId: `test_meeting_${orientation}_${Date.now()}`,
                orientation: orientation,
                meetingInfo: {
                    title: `${orientation === 'conservative' ? 'ë³´ìˆ˜' : 'ì§„ë³´'} ì„±í–¥ ì†Œê°œíŒ…`,
                    date: '12ì›” 15ì¼ í† ìš”ì¼',
                    location: 'ê°•ë‚¨ì—­ ì¹´í˜'
                },
                applicationData: {
                    payment: 'bank'
                }
            };
            
            log('Request data: ' + JSON.stringify(requestData, null, 2));
            
            try {
                const response = await fetch(`${API_URL}/api/meetings/apply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                log(`Response status: ${response.status}`);
                log('Response data: ' + JSON.stringify(result, null, 2));
                
                if (response.ok) {
                    log(`âœ“ ${orientation} ëª¨ì„ ì‹ ì²­ ì„±ê³µ!`, 'success');
                    
                    // sessionStorage ì—…ë°ì´íŠ¸
                    const appliedMeetings = JSON.parse(sessionStorage.getItem('appliedMeetings') || '{}');
                    appliedMeetings[orientation] = {
                        status: 'pending',
                        meetingId: requestData.meetingId,
                        appliedAt: new Date().toISOString()
                    };
                    sessionStorage.setItem('appliedMeetings', JSON.stringify(appliedMeetings));
                    log('sessionStorage ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'success');
                } else {
                    log(`âœ— ì‹ ì²­ ì‹¤íŒ¨: ${result.message}`, 'error');
                }
            } catch (error) {
                log(`API í˜¸ì¶œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        async function checkFirebaseData() {
            log('=== Firebase ë°ì´í„° ì¡°íšŒ ===');
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                log('Auth tokenì´ ì—†ìŠµë‹ˆë‹¤!', 'error');
                return;
            }
            
            const API_URL = window.location.hostname === 'localhost' 
                ? 'http://localhost:3001' 
                : 'https://sidepick.onrender.com';
            
            try {
                const response = await fetch(`${API_URL}/api/user/meetings`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                document.getElementById('firebase-data').textContent = JSON.stringify(data, null, 2);
                
                if (data.meetings && data.meetings.length > 0) {
                    log(`Firebaseì—ì„œ ${data.meetings.length}ê°œì˜ ëª¨ì„ ë°ì´í„° ì¡°íšŒë¨`, 'success');
                    data.meetings.forEach(meeting => {
                        const emoji = meeting.orientation === 'conservative' ? 'ğŸ”µ' : 'ğŸ”´';
                        log(`${emoji} ${meeting.orientation} - Status: ${meeting.status} - ID: ${meeting.id}`);
                    });
                } else {
                    log('Firebaseì— ëª¨ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                }
            } catch (error) {
                log(`Firebase ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ì´ˆê¸° ìƒíƒœ í‘œì‹œ
        checkCurrentState();
        
        // ì •ì¹˜ ì„±í–¥ ì½”ë“œ í•¨ìˆ˜ ì •ì˜
        window.getOrientationFromCode = function(code) {
            const progressiveCodes = ['MPOS', 'MPON', 'MPTS', 'MPTN', 'GPOS', 'GPON', 'GPTS', 'GPTN'];
            return progressiveCodes.includes(code) ? 'progressive' : 'conservative';
        };
    </script>
</body>
</html>